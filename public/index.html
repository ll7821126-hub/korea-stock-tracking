<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>éŸ©å›½è‚¡ç¥¨å®¢æˆ·æŒä»“è¿½è¸ª</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft YaHei",sans-serif;
      background: radial-gradient(circle at top,#e0f2ff 0,#f9fafb 55%,#e5e7eb 100%);
      color: #111827;
    }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .layout {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .title {
      font-size: 22px;
      font-weight: 700;
      color: #111827;
    }
    .subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1d4ed8;
      gap: 4px;
    }

    .grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 14px 16px;
      box-shadow: 0 14px 30px rgba(15,23,42,0.08);
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #111827;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-title span {
      font-size: 11px;
      color: #9ca3af;
      font-weight: 400;
    }

    label {
      display: block;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    input, select, textarea {
      width: 100%;
      border-radius: 9px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #111827;
      font-size: 13px;
      padding: 7px 10px;
      outline: none;
      resize: vertical;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
      background: #ffffff;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform 0.05s ease, box-shadow 0.08s ease, filter 0.08s ease;
      white-space: nowrap;
    }
    .btn:hover { filter: brightness(1.03); }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #ecfdf5;
      box-shadow: 0 10px 20px rgba(22,163,74,0.35);
    }
    .btn-secondary {
      background: #eef2ff;
      color: #1e40af;
      border: 1px solid #c7d2fe;
    }
    .btn-ghost {
      background: #f9fafb;
      color: #4b5563;
      border: 1px solid #e5e7eb;
    }
    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .btn-sm { padding: 4px 10px; font-size: 11px; }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .switch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #6b7280;
    }
    .switch input {
      width: auto;
      height: auto;
      cursor: pointer;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #6b7280;
    }

    /* é¡¶éƒ¨â€œå®¢æˆ·å¡ç‰‡â€ */
    .client-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .client-card {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .client-card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 4px;
      margin-bottom: 2px;
    }
    .client-card-name {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }
    .client-card-rate {
      font-size: 12px;
      font-weight: 600;
    }
    .client-card-rate.positive { color: #16a34a; }
    .client-card-rate.negative { color: #dc2626; }
    .client-card-body {
      font-size: 11px;
      color: #4b5563;
      line-height: 1.4;
    }
    .client-card-body div { margin-bottom: 1px; }
    .client-card-footer {
      display: flex;
      justify-content: flex-start;
      gap: 6px;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    thead {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      white-space: nowrap;
    }
    th {
      font-weight: 500;
      color: #6b7280;
    }
    td.t-left, th.t-left { text-align: left; }

    tbody tr:hover {
      background: #f9fafb;
    }

    .group-row td {
      background: #eff6ff;
      border-bottom-color: #dbeafe;
      font-weight: 600;
      color: #1e3a8a;
    }

    .pill {
      padding: 0 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pill-gain { background: #dcfce7; color: #16a34a; }
    .pill-loss { background: #fee2e2; color: #b91c1c; }
    .pill-neutral { background: #e5e7eb; color: #4b5563; }

    .row-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: nowrap;
    }

    .empty-tip {
      font-size: 12px;
      color: #9ca3af;
      padding: 16px 0;
      text-align: center;
    }

    .footer {
      margin-top: 16px;
      font-size: 10px;
      color: #9ca3af;
      text-align: right;
    }

    /* å¼¹çª—é€šç”¨æ ·å¼ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #ffffff;
      border-radius: 14px;
      max-width: 480px;
      width: 100%;
      padding: 16px 18px 14px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.35);
      position: relative;
    }
    .modal-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #111827;
    }
    .modal-body {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .modal-footer {
      margin-top: 10px;
      text-align: right;
    }
    .modal-close {
      position: absolute;
      right: 14px;
      top: 10px;
    }

    /* è‚¡ç¥¨ç­›é€‰è¾“å…¥æ¡† */
    .stock-filter {
      min-width: 220px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      background: #f9fafb;
    }
    .stock-filter:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
      background: #ffffff;
    }

    /* æ¨èæ ‡ç­¾å°åœ†è§’ */
    .recommend-badge {
      display: inline-flex;
      align-items: center;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #e5e7eb;
      background: #f1f5f9;
      color: #0369a1;
      margin-left: 4px;
    }

    /* å®¢æˆ·æ¡£æ¡ˆå¼¹çª—ï¼ˆå¤§ä¸€ç‚¹ï¼Œå¯æ»šåŠ¨ï¼‰ */
    .profile-modal {
      max-width: 720px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    .profile-modal-body {
      flex: 1;
      overflow: auto;
      padding-right: 4px;
      font-size: 12px;
      color: #4b5563;
    }
    .profile-section {
      margin-top: 10px;
      margin-bottom: 6px;
    }
    .profile-section label {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .profile-row-2 {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 10px;
    }
    .profile-hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .profile-footer-tip {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="layout">
    <header class="header">
      <div>
        <div class="title">éŸ©å›½è‚¡ç¥¨å®¢æˆ·æŒä»“è¿½è¸ª</div>
        <div class="subtitle">
          å®¢æˆ·æŒ‰å§“ååˆ†ç»„ç®¡ç†ï¼Œæ¯ä½å®¢æˆ·å•ç‹¬ç»Ÿè®¡æŠ•å…¥æˆæœ¬ / å½“å‰å¸‚å€¼ / æ”¶ç›Šç‡ï¼Œæ”¯æŒè‡ªåŠ¨åˆ·æ–° Naver è¡Œæƒ…ä¸å¯¼å‡ºæ”¶ç›Šæ—¥æŠ¥ï¼ˆæ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ä¸­ï¼‰ã€‚
        </div>
      </div>
      <div>
        <span class="tag">
          <span>ì‹œì¥</span>
          <strong>KOSPI Â· KOSDAQ</strong>
        </span>
      </div>
    </header>

    <main class="grid">
      <!-- å·¦ä¾§ï¼šæ–°å¢ / ç¼–è¾‘æŒä»“ -->
      <section class="card">
        <div class="card-title">
          æ–°å¢ / ä¿®æ”¹æŒä»“
          <span>ä»£ç ç¤ºä¾‹ï¼š005930ï¼ˆä¸‰æ˜Ÿç”µå­ï¼‰ã€338220ï¼ˆë·°ë…¸ï¼‰</span>
        </div>

        <form id="holdForm">
          <input type="hidden" id="editId" />

          <label>å®¢æˆ·å§“å / åˆ†ç»„å</label>
          <input id="client" placeholder="ä¾‹å¦‚ï¼šæ¨è / é™ˆé›¨VIPç»„" required />

          <label style="margin-top:8px;">è‚¡ç¥¨åç§°</label>
          <input id="stockName" placeholder="ä¾‹å¦‚ï¼šì‚¼ì„±ì „ì / ëŒ€í•œì „ì„ " required />

          <label style="margin-top:8px;">è¯åˆ¸ä»£ç ï¼ˆ6ä½æ•°å­—ï¼‰</label>
          <input id="code" placeholder="ä¾‹å¦‚ï¼š005930 / 338220" required />

          <div class="row" style="margin-top:8px;">
            <div>
              <label>æŒè‚¡æ•°é‡ï¼ˆè‚¡ï¼‰</label>
              <input id="quantity" type="number" min="1" step="1" required />
            </div>
            <div>
              <label>ä¹°å…¥ä»·æ ¼ï¼ˆâ‚©ï¼‰</label>
              <input id="cost" type="number" min="0" step="1" required />
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <div>
              <label>æ­¢æŸä»·ï¼ˆé€‰å¡«ï¼‰</label>
              <input id="stopLoss" type="number" min="0" step="1" />
            </div>
            <div>
              <label>æ­¢ç›ˆä»·ï¼ˆé€‰å¡«ï¼‰</label>
              <input id="takeProfit" type="number" min="0" step="1" />
            </div>
          </div>

          <label style="margin-top:8px;">æ˜¯å¦ä¸ºæ¨èè‚¡</label>
          <select id="recommendType">
            <option value="">å¦</option>
            <option value="recommend">æ¨è</option>
            <option value="good">æ¨èç»©ä¼˜è‚¡</option>
            <option value="switch">æ¨èæ¢ä¼˜è‚¡</option>
          </select>

          <div style="margin-top:10px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
            <button type="submit" class="btn btn-primary">
              <span id="submitLabel">ä¿å­˜æŒä»“</span>
            </button>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button type="button" id="resetBtn" class="btn btn-secondary btn-sm">æ¸…ç©ºè¡¨å•</button>
              <button type="button" id="clearAllBtn" class="btn btn-danger btn-sm">æ¸…ç©ºæ‰€æœ‰æŒä»“ï¼ˆæœ¬æœºï¼‰</button>
            </div>
          </div>

          <div style="margin-top:8px; font-size:11px; color:#6b7280;">
            æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ <span class="badge">localStorage</span> ä¸­ï¼Œåªåœ¨æœ¬æœºå¯è§ã€‚<br/>
            å¦‚éœ€å¤šå°è®¾å¤‡åŒæ­¥ï¼Œå¯ä»¥ä¹‹åå†åšäº‘ç«¯ç‰ˆæœ¬ã€‚
          </div>
        </form>
      </section>

      <!-- å³ä¾§ï¼šå®¢æˆ·å¡ç‰‡ + æ˜ç»† -->
      <section class="card">
        <div class="card-title">
          æŒä»“æ¦‚è§ˆ Â· å®æ—¶æŠ¥ä»·
          <span>è‡ªåŠ¨åˆ·æ–° + å®¢æˆ·å¡ç‰‡ + æ­¢ç›ˆ/æ­¢æŸé¢œè‰²æç¤º</span>
        </div>

        <div class="toolbar">
          <!-- è‚¡ç¥¨ç­›é€‰ -->
          <div class="toolbar-right">
            <input
              id="stockFilter"
              class="stock-filter"
              placeholder="æŒ‰è‚¡ç¥¨åç§° / ä»£ç ç­›é€‰ï¼Œå¦‚ ì‚¼ì„±ì „ì / 005930"
            />
          </div>

          <div class="toolbar-right">
            <button type="button" id="refreshBtn" class="btn btn-secondary btn-sm">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°è¡Œæƒ…</button>
            <div class="switch">
              <input type="checkbox" id="autoRefreshToggle" />
              <label for="autoRefreshToggle" style="margin:0;">è‡ªåŠ¨åˆ·æ–°</label>
            </div>
            <select id="intervalSelect" style="width:auto; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #d1d5db;">
              <option value="30">30ç§’</option>
              <option value="60" selected>60ç§’</option>
              <option value="120">120ç§’</option>
            </select>
          </div>

          <div class="toolbar-right">
            <button type="button" id="exportBtn" class="btn btn-ghost btn-sm">ğŸ“¤ å¯¼å‡ºæ”¶ç›Šæ—¥æŠ¥ï¼ˆCSVï¼‰</button>
          </div>
        </div>

        <!-- é¡¶éƒ¨å®¢æˆ·å¡ç‰‡ -->
        <div id="clientCards" class="client-card-grid"></div>

        <!-- æ˜ç»†è¡¨æ ¼ -->
        <div style="max-height:420px; overflow:auto; border-radius:10px; border:1px solid #e5e7eb;">
          <table>
            <thead>
              <tr>
                <th class="t-left">å®¢æˆ·</th>
                <th class="t-left">è‚¡ç¥¨</th>
                <th>ä»£ç </th>
                <th>æ•°é‡</th>
                <th>æˆæœ¬ä»·</th>
                <th>æ­¢æŸ</th>
                <th>æ­¢ç›ˆ</th>
                <th>ç°ä»·</th>
                <th>å¸‚å€¼</th>
                <th>ç›ˆäº</th>
                <th>æ”¶ç›Šç‡</th>
                <th class="t-left">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <div id="emptyTip" class="empty-tip" style="display:none;">
          è¿˜æ²¡æœ‰å½•å…¥ä»»ä½•æŒä»“è®°å½•ï¼Œè¯·åœ¨å·¦ä¾§å¡«å†™å®¢æˆ·ä¸è‚¡ç¥¨ä¿¡æ¯åç‚¹å‡»â€œä¿å­˜æŒä»“â€ã€‚
        </div>

        <div class="footer">
          Data by Naver Finance Â· æ¯ä½ç”¨æˆ·æ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ä¸­ã€‚
        </div>
      </section>
    </main>
  </div>

  <!-- AI è§£æå¼¹çª— -->
  <div id="aiModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <button type="button" class="btn btn-ghost btn-sm modal-close" onclick="closeAiModal()">å…³é—­</button>
      <div class="modal-title">AI è§£æå»ºè®®ï¼ˆç¤ºæ„é€»è¾‘ï¼Œæœ¬åœ°ç”Ÿæˆï¼‰</div>
      <div id="aiModalBody" class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" onclick="closeAiModal()">å¥½çš„ï¼ŒçŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <!-- å–å‡ºå¼¹çª— -->
  <div id="sellModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <button type="button" class="btn btn-ghost btn-sm modal-close" onclick="closeSellModal()">å…³é—­</button>
      <div class="modal-title">å–å‡ºæ€»ç»“ï¼ˆä»…æœ¬åœ°æ¨¡æ‹Ÿï¼‰</div>
      <div id="sellModalBody" class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" onclick="closeSellModal()">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- å®¢æˆ·æ¡£æ¡ˆå¼¹çª— -->
  <div id="clientProfileBackdrop" class="modal-backdrop">
    <div class="modal profile-modal">
      <button type="button" class="btn btn-ghost btn-sm modal-close" onclick="closeClientProfile()">å…³é—­</button>
      <div class="modal-title" id="profileModalTitle">å®¢æˆ·æ¡£æ¡ˆ</div>
      <div class="profile-modal-body">
        <div class="profile-section">
          <label>å®¢æˆ·ï¼š</label>
          <div id="profileClientName" style="font-weight:600;margin-top:2px;"></div>
        </div>

        <div class="profile-section profile-row-2">
          <div>
            <label>æ€§åˆ«</label>
            <select id="profileGender">
              <option value="">æœªå¡«å†™</option>
              <option value="ç”·">ç”·</option>
              <option value="å¥³">å¥³</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div>
            <label>å¹´é¾„ï¼ˆå²ï¼‰</label>
            <input id="profileAge" type="number" min="0" placeholder="ä¾‹å¦‚ï¼š46" />
          </div>
        </div>

        <div class="profile-section profile-row-2">
          <div>
            <label>è‚¡é¾„ / æŠ•èµ„æ—¶é—´</label>
            <input id="profileInvestYears" placeholder="ä¾‹å¦‚ï¼šæ–°æ‰‹ / 2å¹´" />
          </div>
          <div>
            <label>ç‚’è‚¡æ“ä½œæ–¹å¼</label>
            <input id="profileTradingStyle" placeholder="ä¾‹å¦‚ï¼šçŸ­çº¿ / æ³¢æ®µ / é•¿çº¿" />
          </div>
        </div>

        <div class="profile-section">
          <label>å…´è¶£çˆ±å¥½</label>
          <input id="profileHobbies" placeholder="ä¾‹å¦‚ï¼šè¶³çƒ / æ—…æ¸¸ / æ‘„å½±ç­‰" />
        </div>

        <div class="profile-section">
          <label>å®¶åº­æƒ…å†µ</label>
          <input id="profileFamily" placeholder="ä¾‹å¦‚ï¼šå·²å©šä¸‰ä¸ªå­©å­ / ç‹¬å±…ç­‰" />
        </div>

        <div class="profile-section">
          <label>å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label>
          <textarea id="profileNote" rows="3" placeholder="ä¾‹å¦‚ï¼šé£é™©æ‰¿å—èƒ½åŠ›ã€èŒä¸šã€æ”¶å…¥ç¨³å®šæ€§ç­‰"></textarea>
        </div>

        <div class="profile-footer-tip">
          å®¢æˆ·æ¡£æ¡ˆä¿¡æ¯ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ä¸­ï¼Œç”¨äºæ—¥å¸¸æ²Ÿé€šä¸æŠ•èµ„åå¥½ç®¡ç†ã€‚
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" onclick="saveClientProfile()">ä¿å­˜æ¡£æ¡ˆ</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "korea_portfolio_holdings_v3";
    const PROFILE_KEY = "korea_client_profiles_v1";

    // DOM - æŒä»“ä¸è¡¨æ ¼
    const form = document.getElementById("holdForm");
    const editIdInput = document.getElementById("editId");
    const clientInput = document.getElementById("client");
    const stockNameInput = document.getElementById("stockName");
    const codeInput = document.getElementById("code");
    const quantityInput = document.getElementById("quantity");
    const costInput = document.getElementById("cost");
    const stopLossInput = document.getElementById("stopLoss");
    const takeProfitInput = document.getElementById("takeProfit");
    const recommendTypeSelect = document.getElementById("recommendType");
    const resetBtn = document.getElementById("resetBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const autoToggle = document.getElementById("autoRefreshToggle");
    const intervalSelect = document.getElementById("intervalSelect");
    const exportBtn = document.getElementById("exportBtn");
    const tableBody = document.getElementById("tableBody");
    const emptyTip = document.getElementById("emptyTip");
    const clientCardsEl = document.getElementById("clientCards");

    // DOM - å¼¹çª—
    const aiModalBackdrop = document.getElementById("aiModalBackdrop");
    const aiModalBody = document.getElementById("aiModalBody");
    const sellModalBackdrop = document.getElementById("sellModalBackdrop");
    const sellModalBody = document.getElementById("sellModalBody");
    const stockFilterInput = document.getElementById("stockFilter");

    // å®¢æˆ·æ¡£æ¡ˆå¼¹çª— DOM
    const clientProfileBackdrop = document.getElementById("clientProfileBackdrop");
    const profileModalTitle = document.getElementById("profileModalTitle");
    const profileClientNameEl = document.getElementById("profileClientName");
    const profileGenderEl = document.getElementById("profileGender");
    const profileAgeEl = document.getElementById("profileAge");
    const profileInvestYearsEl = document.getElementById("profileInvestYears");
    const profileTradingStyleEl = document.getElementById("profileTradingStyle");
    const profileHobbiesEl = document.getElementById("profileHobbies");
    const profileFamilyEl = document.getElementById("profileFamily");
    const profileNoteEl = document.getElementById("profileNote");

    let holdings = [];
    let autoTimer = null;
    let stockFilterKeyword = "";
    let clientProfiles = {};
    let currentProfileClient = null;

    function loadHoldings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        holdings = raw ? JSON.parse(raw) : [];
      } catch (e) {
        holdings = [];
      }
    }

    function saveHoldings() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(holdings));
      renderAll();
    }

    function loadClientProfiles() {
      try {
        const raw = localStorage.getItem(PROFILE_KEY);
        clientProfiles = raw ? JSON.parse(raw) : {};
      } catch (e) {
        clientProfiles = {};
      }
    }

    function saveClientProfiles() {
      localStorage.setItem(PROFILE_KEY, JSON.stringify(clientProfiles));
    }

    function formatNumber(n) {
      return Number(n || 0).toLocaleString("ko-KR");
    }

    function formatPercent(v) {
      const n = Number(v);
      if (!isFinite(n)) return "0.00%";
      const s = n.toFixed(2) + "%";
      return n > 0 ? "+" + s : s;
    }

    function groupByClient(list) {
      const map = {};
      list.forEach(h => {
        const key = h.client || "æœªå‘½åå®¢æˆ·";
        if (!map[key]) map[key] = [];
        map[key].push(h);
      });
      return map;
    }

    function getFilteredHoldings() {
      if (!stockFilterKeyword) return holdings;
      return holdings.filter(h => {
        const name = (h.stockName || "").toLowerCase();
        const code = (h.code || "").toLowerCase();
        return (
          name.includes(stockFilterKeyword) ||
          code.includes(stockFilterKeyword)
        );
      });
    }

    // é¡¶éƒ¨å®¢æˆ·å¡ç‰‡
    function renderClientCards() {
      clientCardsEl.innerHTML = "";
      const filtered = getFilteredHoldings();
      if (!filtered.length) return;

      const groups = groupByClient(filtered);
      const clients = Object.keys(groups).sort();

      clients.forEach(clientName => {
        const list = groups[clientName];

        let costSum = 0, valSum = 0, qtySum = 0;
        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          qtySum += qty;
          costSum += qty * cost;
          valSum += qty * cur;
        });
        const pnl = valSum - costSum;
        const rate = costSum > 0 ? (pnl / costSum) * 100 : 0;

        const card = document.createElement("div");
        card.className = "client-card";

        const header = document.createElement("div");
        header.className = "client-card-header";
        const nameEl = document.createElement("div");
        nameEl.className = "client-card-name";
        nameEl.textContent = clientName;
        const rateEl = document.createElement("div");
        rateEl.className =
          "client-card-rate " +
          (rate > 0 ? "positive" : rate < 0 ? "negative" : "");
        rateEl.textContent = formatPercent(rate);
        header.appendChild(nameEl);
        header.appendChild(rateEl);

        const body = document.createElement("div");
        body.className = "client-card-body";

        // æ¡£æ¡ˆä¿¡æ¯è¡Œ
        const profile = clientProfiles[clientName] || {};
        const genderText = profile.gender || "æœªå¡«";
        const ageText = profile.age ? profile.age + "å²" : "";
        const investText = profile.investYears || "";
        const profileLine = document.createElement("div");
        profileLine.textContent =
          "æ¡£æ¡ˆï¼š" +
          [genderText, ageText, investText].filter(Boolean).join(" / ");

        const line1 = document.createElement("div");
        line1.textContent = `åŸºæœ¬ä¿¡æ¯ï¼š${list.length} åªè‚¡ç¥¨ / åˆè®¡ ${qtySum.toLocaleString("ko-KR")} è‚¡`;
        const line2 = document.createElement("div");
        line2.textContent = `æ€»æŠ•å…¥æˆæœ¬ï¼šâ‚© ${formatNumber(costSum)}`;
        const line3 = document.createElement("div");
        line3.textContent = `å½“å‰å¸‚å€¼ï¼šâ‚© ${formatNumber(valSum)}`;
        const line4 = document.createElement("div");
        line4.textContent = `æ€»ç›ˆäºï¼šâ‚© ${formatNumber(pnl)}`;

        body.appendChild(profileLine);
        body.appendChild(line1);
        body.appendChild(line2);
        body.appendChild(line3);
        body.appendChild(line4);

        const footer = document.createElement("div");
        footer.className = "client-card-footer";

        const detailBtn = document.createElement("button");
        detailBtn.type = "button";
        detailBtn.className = "btn btn-ghost btn-sm";
        detailBtn.textContent = "å®¢æˆ·æ¡£æ¡ˆ";
        detailBtn.onclick = () => openClientProfile(clientName);

        const aiBtn = document.createElement("button");
        aiBtn.type = "button";
        aiBtn.className = "btn btn-secondary btn-sm";
        aiBtn.textContent = "AIè§£æå»ºè®®";
        aiBtn.onclick = () => openClientAiSummary(clientName);

        footer.appendChild(detailBtn);
        footer.appendChild(aiBtn);

        card.appendChild(header);
        card.appendChild(body);
        card.appendChild(footer);

        clientCardsEl.appendChild(card);
      });
    }

    // è¡¨æ ¼
    function renderTable() {
      tableBody.innerHTML = "";
      const filtered = getFilteredHoldings();

      if (!filtered.length) {
        emptyTip.style.display = "block";
        emptyTip.textContent = stockFilterKeyword
          ? `æœªæ‰¾åˆ°åŒ…å«ã€Œ${stockFilterKeyword}ã€çš„æŒä»“è®°å½•ã€‚`
          : "è¿˜æ²¡æœ‰å½•å…¥ä»»ä½•æŒä»“è®°å½•ï¼Œè¯·åœ¨å·¦ä¾§å¡«å†™å®¢æˆ·ä¸è‚¡ç¥¨ä¿¡æ¯åç‚¹å‡»â€œä¿å­˜æŒä»“â€ã€‚";
        return;
      }
      emptyTip.style.display = "none";

      const groups = groupByClient(filtered);
      const clients = Object.keys(groups).sort();

      clients.forEach(clientName => {
        const list = groups[clientName];

        let clientCost = 0;
        let clientValue = 0;
        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          clientCost += qty * cost;
          clientValue += qty * cur;
        });
        const clientPnl = clientValue - clientCost;
        const clientRate = clientCost > 0 ? (clientPnl / clientCost) * 100 : 0;

        const gtr = document.createElement("tr");
        gtr.className = "group-row";
        const gtd = document.createElement("td");
        gtd.colSpan = 12;
        gtd.className = "t-left";
        gtd.textContent =
          `${clientName}ï½œæŠ•å…¥ â‚© ${formatNumber(clientCost)}ï½œå¸‚å€¼ â‚© ${formatNumber(clientValue)}ï½œç›ˆäº â‚© ${formatNumber(clientPnl)}ï¼ˆ${formatPercent(clientRate)}ï¼‰`;
        gtr.appendChild(gtd);
        tableBody.appendChild(gtr);

        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          const value = qty * cur;
          const pnl = value - qty * cost;
          const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

          const tr = document.createElement("tr");

          if (h.currentPrice != null) {
            const cp = Number(h.currentPrice);
            if (h.stopLoss && cp <= Number(h.stopLoss)) {
              tr.style.background = "#fee2e2";
            } else if (h.takeProfit && cp >= Number(h.takeProfit)) {
              tr.style.background = "#dcfce7";
            }
          }

          const tdClient = document.createElement("td");
          tdClient.className = "t-left";
          tdClient.textContent = h.client;

          if (h.recommendType) {
            const badge = document.createElement("span");
            badge.className = "recommend-badge";
            badge.textContent =
              h.recommendType === "recommend"
                ? "æ¨è"
                : h.recommendType === "good"
                ? "æ¨èç»©ä¼˜"
                : "æ¢ä¼˜è‚¡";
            tdClient.appendChild(badge);
          }

          const tdStock = document.createElement("td");
          tdStock.className = "t-left";
          if (h.code) {
            const link = document.createElement("a");
            link.href = `https://finance.naver.com/item/sise.nhn?code=${h.code}`;
            link.target = "_blank";
            link.rel = "noopener noreferrer";
            link.textContent = h.stockName || "-";
            tdStock.appendChild(link);
          } else {
            tdStock.textContent = h.stockName;
          }

          const tdCode = document.createElement("td");
          tdCode.textContent = h.code || "-";

          const tdQty = document.createElement("td");
          tdQty.textContent = formatNumber(qty);

          const tdCost = document.createElement("td");
          tdCost.textContent = formatNumber(cost);

          const tdSL = document.createElement("td");
          tdSL.textContent = h.stopLoss ? formatNumber(Number(h.stopLoss)) : "-";

          const tdTP = document.createElement("td");
          tdTP.textContent = h.takeProfit ? formatNumber(Number(h.takeProfit)) : "-";

          const tdCur = document.createElement("td");
          tdCur.textContent = h.currentPrice != null ? formatNumber(Number(h.currentPrice)) : "-";

          const tdVal = document.createElement("td");
          tdVal.textContent = formatNumber(value);

          const tdPnl = document.createElement("td");
          tdPnl.textContent = formatNumber(pnl);
          tdPnl.style.color = pnl > 0 ? "#16a34a" : pnl < 0 ? "#b91c1c" : "#111827";
          tdPnl.style.fontWeight = "600";

          const tdRate = document.createElement("td");
          const pill = document.createElement("span");
          pill.className =
            "pill " +
            (rate > 0 ? "pill-gain" : rate < 0 ? "pill-loss" : "pill-neutral");
          pill.textContent = formatPercent(rate);
          tdRate.appendChild(pill);

          const tdActions = document.createElement("td");
          tdActions.className = "t-left";
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "row-actions";

          const oneRefreshBtn = document.createElement("button");
          oneRefreshBtn.type = "button";
          oneRefreshBtn.className = "btn btn-ghost btn-sm";
          oneRefreshBtn.textContent = "ğŸ”„";
          oneRefreshBtn.title = "åˆ·æ–°è¯¥è‚¡ç¥¨è¡Œæƒ…";
          oneRefreshBtn.onclick = () => refreshPrices([h.code]);

          const aiBtn = document.createElement("button");
          aiBtn.type = "button";
          aiBtn.className = "btn btn-secondary btn-sm";
          aiBtn.textContent = "AIè§£æ";
          aiBtn.onclick = () => openAiModal(h);

          const sellBtn = document.createElement("button");
          sellBtn.type = "button";
          sellBtn.className = "btn btn-ghost btn-sm";
          sellBtn.textContent = "å–å‡º";
          sellBtn.onclick = () => openSellModal(h);

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-ghost btn-sm";
          editBtn.textContent = "ç¼–è¾‘";
          editBtn.onclick = () => startEdit(h.id);

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-danger btn-sm";
          delBtn.textContent = "åˆ é™¤";
          delBtn.onclick = () => deleteHolding(h.id);

          actionsDiv.appendChild(oneRefreshBtn);
          actionsDiv.appendChild(aiBtn);
          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(sellBtn);
          actionsDiv.appendChild(delBtn);
          tdActions.appendChild(actionsDiv);

          tr.appendChild(tdClient);
          tr.appendChild(tdStock);
          tr.appendChild(tdCode);
          tr.appendChild(tdQty);
          tr.appendChild(tdCost);
          tr.appendChild(tdSL);
          tr.appendChild(tdTP);
          tr.appendChild(tdCur);
          tr.appendChild(tdVal);
          tr.appendChild(tdPnl);
          tr.appendChild(tdRate);
          tr.appendChild(tdActions);

          tableBody.appendChild(tr);
        });
      });
    }

    function renderAll() {
      renderClientCards();
      renderTable();
    }

    function resetForm() {
      editIdInput.value = "";
      submitLabel.textContent = "ä¿å­˜æŒä»“";
      form.reset();
    }

    const submitLabel = document.getElementById("submitLabel");

    function startEdit(id) {
      const h = holdings.find(x => x.id === id);
      if (!h) return;
      editIdInput.value = h.id;
      clientInput.value = h.client;
      stockNameInput.value = h.stockName;
      codeInput.value = h.code;
      quantityInput.value = h.quantity;
      costInput.value = h.cost;
      stopLossInput.value = h.stopLoss ?? "";
      takeProfitInput.value = h.takeProfit ?? "";
      recommendTypeSelect.value = h.recommendType || "";
      submitLabel.textContent = "ä¿å­˜ä¿®æ”¹";
    }

    function deleteHolding(id) {
      if (!confirm("ç¡®å®šåˆ é™¤è¯¥æ¡æŒä»“è®°å½•å—ï¼Ÿ")) return;
      holdings = holdings.filter(h => h.id !== id);
      saveHoldings();
      resetForm();
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const client = clientInput.value.trim();
      const stockName = stockNameInput.value.trim();
      const code = codeInput.value.trim();
      const quantity = Number(quantityInput.value);
      const cost = Number(costInput.value);
      const stopLoss = stopLossInput.value ? Number(stopLossInput.value) : null;
      const takeProfit = takeProfitInput.value ? Number(takeProfitInput.value) : null;
      const recommendType = recommendTypeSelect.value || "";

      if (!client || !stockName || !code || !quantity || !cost) {
        alert("è¯·å®Œæ•´å¡«å†™å¿…å¡«é¡¹ã€‚");
        return;
      }

      const id = editIdInput.value;
      if (id) {
        const idx = holdings.findIndex(h => h.id === id);
        if (idx >= 0) {
          holdings[idx] = {
            ...holdings[idx],
            client, stockName, code,
            quantity, cost, stopLoss, takeProfit,
            recommendType
          };
        }
      } else {
        holdings.push({
          id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          client,
          stockName,
          code,
          quantity,
          cost,
          stopLoss,
          takeProfit,
          recommendType,
          currentPrice: null,
          updatedAt: null
        });
      }
      saveHoldings();
      resetForm();
    });

    resetBtn.addEventListener("click", () => {
      resetForm();
    });

    clearAllBtn.addEventListener("click", () => {
      if (!confirm("ç¡®å®šæ¸…ç©ºæœ¬æœºæ‰€æœ‰æŒä»“è®°å½•å—ï¼Ÿ")) return;
      holdings = [];
      saveHoldings();
      resetForm();
    });

    // è‡ªåŠ¨åˆ·æ–°
    function setAutoRefresh(on) {
      if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
      }
      if (on) {
        const sec = Number(intervalSelect.value) || 60;
        autoTimer = setInterval(() => {
          if (holdings.length) refreshPrices();
        }, sec * 1000);
      }
    }

    autoToggle.addEventListener("change", () => {
      setAutoRefresh(autoToggle.checked);
      if (autoToggle.checked && holdings.length) {
        refreshPrices();
      }
    });

    intervalSelect.addEventListener("change", () => {
      if (autoToggle.checked) setAutoRefresh(true);
    });

    refreshBtn.addEventListener("click", () => {
      refreshPrices();
    });

    // è‚¡ç¥¨ç­›é€‰
    stockFilterInput.addEventListener("input", () => {
      stockFilterKeyword = stockFilterInput.value.trim().toLowerCase();
      renderClientCards();
      renderTable();
    });

    // åˆ·æ–°è¡Œæƒ…
    async function refreshPrices(symbolsOverride) {
      try {
        if (!holdings.length && !symbolsOverride) return;

        let symbols;
        if (symbolsOverride && symbolsOverride.length) {
          symbols = Array.from(new Set(symbolsOverride.filter(Boolean)));
        } else {
          symbols = Array.from(
            new Set(holdings.map(h => h.code).filter(Boolean))
          );
        }
        if (!symbols.length) return;

        const res = await fetch("/api/prices", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ symbols })
        });

        if (!res.ok) {
          console.error("è¡Œæƒ…æ¥å£é”™è¯¯:", await res.text());
          return;
        }

        const data = await res.json();
        const now = new Date().toISOString();

        holdings.forEach(h => {
          const info = data[h.code];
          if (info && info.ok) {
            h.currentPrice = Number(info.price);
            h.updatedAt = now;
          }
        });

        saveHoldings();
      } catch (e) {
        console.error("åˆ·æ–°è¡Œæƒ…å¼‚å¸¸:", e);
      }
    }

    // å¯¼å‡º CSV
    exportBtn.addEventListener("click", () => {
      if (!holdings.length) {
        alert("å½“å‰æ²¡æœ‰ä»»ä½•æŒä»“è®°å½•å¯å¯¼å‡ºã€‚");
        return;
      }
      const rows = [];
      rows.push([
        "å®¢æˆ·",
        "è‚¡ç¥¨",
        "ä»£ç ",
        "æ•°é‡",
        "æˆæœ¬ä»·",
        "ç°ä»·",
        "å¸‚å€¼",
        "ç›ˆäº",
        "æ”¶ç›Šç‡(%)",
        "æ­¢æŸ",
        "æ­¢ç›ˆ",
        "æ¨èç±»å‹",
        "æ›´æ–°æ—¶é—´"
      ]);

      holdings.forEach(h => {
        const qty = Number(h.quantity) || 0;
        const cost = Number(h.cost) || 0;
        const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
        const val = qty * cur;
        const pnl = val - qty * cost;
        const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

        const recommendLabel =
          h.recommendType === "recommend"
            ? "æ¨è"
            : h.recommendType === "good"
            ? "æ¨èç»©ä¼˜è‚¡"
            : h.recommendType === "switch"
            ? "æ¨èæ¢ä¼˜è‚¡"
            : "";

        rows.push([
          h.client,
          h.stockName,
          h.code,
          qty,
          cost,
          cur,
          val,
          pnl,
          rate.toFixed(2),
          h.stopLoss ?? "",
          h.takeProfit ?? "",
          recommendLabel,
          h.updatedAt ? new Date(h.updatedAt).toLocaleString("zh-CN") : ""
        ]);
      });

      const csv = rows
        .map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(","))
        .join("\r\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2,"0");
      const d = String(now.getDate()).padStart(2,"0");
      a.href = url;
      a.download = `korea_portfolio_daily_${y}${m}${d}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // AI è§£æï¼šå•ç¥¨
    function openAiModal(h) {
      const qty = Number(h.quantity) || 0;
      const cost = Number(h.cost) || 0;
      const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
      const value = qty * cur;
      const pnl = value - qty * cost;
      const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

      let tone = "";
      if (rate > 20) tone = "æ”¶ç›ŠåŒºé—´å·²ç»æ¯”è¾ƒå¯è§‚ï¼Œå¯ä»¥è€ƒè™‘åˆ†æ‰¹é”å®šåˆ©æ¶¦ï¼Œé¿å…æƒ…ç»ªåŒ–è¿½é«˜ã€‚";
      else if (rate > 5) tone = "æ•´ä½“èŠ‚å¥è¿˜å¯ä»¥ï¼ŒçŸ­æœŸæ³¨æ„é‡èƒ½å˜åŒ–ï¼Œçªç ´æ— é‡è¦é€‚å½“æ”¶ç¼©ä»“ä½ã€‚";
      else if (rate > -5) tone = "ç›®å‰ç›ˆäºéƒ½ä¸å¤§ï¼Œå…ˆæŠŠä»“ä½å½“æˆâ€œè§‚å¯Ÿç¥¨â€ï¼Œé‡ç‚¹ç›¯ä½æ”¯æ’‘ä½å’Œæˆäº¤é‡ã€‚";
      else if (rate > -15) tone = "å›æ’¤å¹…åº¦ä¸ç®—å°äº†ï¼Œä¸‹æ–¹æ”¯æ’‘ä¸€æ—¦è·Œç ´è¦æœæ–­æ‰§è¡Œæ­¢æŸï¼Œä¸è¦å†æ‹–å»¶ã€‚";
      else tone = "äºæŸåŒºé—´å·²ç»åå¤§äº†ï¼Œå»ºè®®å…ˆæŠŠä»“ä½æ‹†æˆå‡ ä»½ï¼ŒæŒ‰åå¼¹èŠ‚å¥åˆ†æ‰¹å‡æ‰ï¼Œæ§åˆ¶æ•´ä½“é£é™©ã€‚";

      const text =
        `ã€${h.client || "å®¢æˆ·"} Â· ${h.stockName || ""}ã€‘\n` +
        `å½“å‰ä»“ä½çº¦ ${qty.toLocaleString("ko-KR")} è‚¡ï¼Œæˆæœ¬ä»· â‚©${formatNumber(cost)}ï¼Œ` +
        `æœ€æ–°ä»·çº¦ â‚©${formatNumber(cur)}ï¼Œæµ®åŠ¨ç›ˆäºçº¦ â‚©${formatNumber(pnl)}ï¼ˆ${formatPercent(rate)}ï¼‰ã€‚\n\n` +
        `èµ°åŠ¿ä¸Šä¼˜å…ˆå…³æ³¨ï¼šå‰æœŸå¹³å°æ”¯æ’‘ã€5æ—¥/20æ—¥å‡çº¿ä»¥åŠæœ€è¿‘æ”¾é‡ä½ç½®ï¼Œå¦‚æœåç»­æ”¾é‡ä¸Šå†²ä½†å®ä½“æ”¶å¾—å¾ˆçŸ­ï¼Œè¦é˜²èŒƒä¸»åŠ›é«˜ä½å‡ä»“ã€‚\n` +
        `æ­¢ç›ˆæ­¢æŸä¸Šå»ºè®®ï¼šæ­¢æŸä»·å¯ä»¥å‚è€ƒä½ åœ¨ç³»ç»Ÿé‡Œå¡«å†™çš„ä»·ä½ï¼Œè‹¥æœªå¡«å†™ï¼Œå¯å…ˆæŠŠâ€œæœ€è¿‘æ˜æ˜¾æ”¯æ’‘ä½ä¸‹æ–¹ 2~3%â€å½“ä½œç¡¬æ­¢æŸçº¿ï¼›æ­¢ç›ˆåˆ™åˆ†ä¸¤æ­¥æ‰§è¡Œï¼Œ` +
        `ç¬¬ä¸€ç›®æ ‡ä½åœ¨å‰é«˜é™„è¿‘ï¼Œç¬¬äºŒç›®æ ‡ä½çœ‹æ”¾é‡çªç ´åçš„è·Ÿè¸ªç©ºé—´ã€‚\n\n` +
        tone + ` æ•´ä½“ä¸ŠèŠ‚å¥å®å¯æ…¢ä¸€ç‚¹ï¼Œä¹Ÿå°½é‡åšåˆ°â€œå…ˆè°ˆå¥½æ­¢ç›ˆæ­¢æŸï¼Œå†å†³å®šæ˜¯å¦åŠ ä»“æˆ–ç»§ç»­æŒæœ‰â€ã€‚`;

      aiModalBody.textContent = text;
      aiModalBackdrop.style.display = "flex";
    }

    function closeAiModal() {
      aiModalBackdrop.style.display = "none";
    }

    // å–å‡ºæ€»ç»“
    function openSellModal(h) {
      const qty = Number(h.quantity) || 0;
      const cost = Number(h.cost) || 0;
      const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
      const value = qty * cur;
      const pnl = value - qty * cost;
      const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

      const text =
        `ã€æ¨¡æ‹Ÿå–å‡ºæ€»ç»“ã€‘\n` +
        `å®¢æˆ·ï¼š${h.client || "-"}\n` +
        `æ ‡çš„ï¼š${h.stockName || ""}ï¼ˆ${h.code || ""}ï¼‰\n` +
        `æ•°é‡ï¼š${qty.toLocaleString("ko-KR")} è‚¡\n` +
        `ä¹°å…¥æˆæœ¬ï¼šâ‚©${formatNumber(cost)}\n` +
        `å‡è®¾å–å‡ºä»·ï¼šâ‚©${formatNumber(cur)}ï¼ˆå½“å‰ä»·ï¼‰\n\n` +
        `æŠ•å…¥æˆæœ¬åˆè®¡ï¼šâ‚©${formatNumber(qty * cost)}\n` +
        `å–å‡ºé‡‘é¢åˆè®¡ï¼šâ‚©${formatNumber(value)}\n` +
        `æœ¬æ¬¡ç›ˆäºï¼šâ‚©${formatNumber(pnl)}ï¼ˆ${formatPercent(rate)}ï¼‰\n\n` +
        `æç¤ºï¼šè¿™é‡Œåªæ˜¯å¸®åŠ©ä½ å¿«é€Ÿç»™å®¢æˆ·æ±‡æ€»ç»“æœï¼Œå¹¶æ²¡æœ‰çœŸæ­£ä»ç³»ç»Ÿé‡Œåˆ é™¤æŒä»“è®°å½•ï¼Œå¦‚éœ€æ¸…ä»“ï¼Œè¯·åœ¨ç¡®è®¤åæ‰‹åŠ¨è°ƒæ•´ã€‚`;

      sellModalBody.textContent = text;
      sellModalBackdrop.style.display = "flex";
    }

    function closeSellModal() {
      sellModalBackdrop.style.display = "none";
    }

    // å®¢æˆ· AI ç»¼åˆå»ºè®®ï¼ˆæŒ‰ç»„åˆï¼‰
    function openClientAiSummary(clientName) {
      const filtered = getFilteredHoldings();
      const groups = groupByClient(filtered);
      const list = groups[clientName] || [];
      if (!list.length) return;

      let costSum = 0, valueSum = 0;
      list.forEach(h => {
        const qty = Number(h.quantity) || 0;
        const cost = Number(h.cost) || 0;
        const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
        costSum += qty * cost;
        valueSum += qty * cur;
      });
      const pnl = valueSum - costSum;
      const rate = costSum > 0 ? (pnl / costSum) * 100 : 0;

      let tone = "";
      if (rate > 20) tone = "æ•´ä½“ç»„åˆæ”¶ç›Šå·²ç»éå¸¸å¯è§‚ï¼Œå»ºè®®ä¼˜å…ˆé”å®šä¸€éƒ¨åˆ†åˆ©æ¶¦ï¼ŒæŠŠè´¦é¢æ”¶ç›Šè½è¢‹ä¸ºå®‰ã€‚";
      else if (rate > 5) tone = "ç»„åˆèŠ‚å¥è¿˜ä¸é”™ï¼Œå¯ä»¥åœ¨å¼ºåŠ¿è‚¡ä¸Šé€‚å½“åˆ†æ‰¹å‡ä»“ï¼ŒåŒæ—¶ç»™ä½ä½æ ‡çš„é¢„ç•™ä¸€ç‚¹å¼¹è¯ã€‚";
      else if (rate > -5) tone = "ç›®å‰æ•´ä½“åœ¨å¯æ¥å—åŒºé—´å†…ï¼Œå…ˆæŠŠæ¯åªè‚¡ç¥¨çš„æ­¢æŸä»·å’Œè§‚å¯Ÿä½ç¡®è®¤å¥½ï¼Œä»¥ç¨³ä¸ºä¸»ã€‚";
      else if (rate > -15) tone = "ç»„åˆå›æ’¤æœ‰ç‚¹åå¤§äº†ï¼Œå»ºè®®æŠŠå¼±åŠ¿è‚¡å’Œé€»è¾‘å˜åŒ–ä¸å¥½çš„æ ‡çš„ä¼˜å…ˆå‡æ‰ï¼Œç¼“ä¸€ç¼“æ•´ä½“é£é™©ã€‚";
      else tone = "å½“å‰æ•´ä½“å‹åŠ›è¾ƒå¤§ï¼Œå…ˆæ§åˆ¶å¥½æ€»ä»“ä½ï¼Œé¿å…å†åŠ ä»“è¡¥è·Œï¼Œåé¢ç­‰è¶‹åŠ¿ä¼ç¨³å†è€ƒè™‘é‡æ–°å¸ƒå±€ã€‚";

      const text =
        `ã€${clientName} Â· ç»„åˆçº§åˆ«å»ºè®®ã€‘\n` +
        `ç»„åˆæ€»æŠ•å…¥çº¦ â‚©${formatNumber(costSum)}ï¼Œå½“å‰å¸‚å€¼çº¦ â‚©${formatNumber(valueSum)}ï¼Œ` +
        `æ•´ä½“æµ®åŠ¨ç›ˆäºçº¦ â‚©${formatNumber(pnl)}ï¼ˆ${formatPercent(rate)}ï¼‰ã€‚\n\n` +
        `ä»ç»“æ„ä¸Šçœ‹ï¼Œå¯ä»¥ä¼˜å…ˆåŒºåˆ†ï¼š\n` +
        `â‘  å¼ºåŠ¿è¶‹åŠ¿ç¥¨ï¼šç¼©é‡å›è¸©ä¸ç ´æ”¯æ’‘çš„æ ‡çš„ï¼Œé€‚åˆåšâ€œé«˜ä½å‡ä»“ï¼Œå›è°ƒå†æ¥â€ï¼›\n` +
        `â‘¡ å¼±åŠ¿æˆ–é€»è¾‘å˜å¼±ç¥¨ï¼šè¿ç»­è·Œç ´æ”¯æ’‘ã€æˆäº¤é‡æ”¾å¤§ä½†è‚¡ä»·ä¸è·Ÿæ¶¨çš„æ ‡çš„ï¼Œè¦è€ƒè™‘æœæ–­è°ƒä»“ã€‚\n\n` +
        tone + ` æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥æŒ‰â€œæ ¸å¿ƒæŒä»“ + å«æ˜Ÿä»“ä½â€çš„æ€è·¯ï¼Œä¸€èµ·æŠŠç»„åˆåšå¾—æ›´ç¨³ã€æ›´è½»æ¾ã€‚`;

      aiModalBody.textContent = text;
      aiModalBackdrop.style.display = "flex";
    }

    // å®¢æˆ·æ¡£æ¡ˆå¼¹çª—é€»è¾‘
    function openClientProfile(clientName) {
      currentProfileClient = clientName;
      profileModalTitle.textContent = clientName + " Â· å®¢æˆ·æ¡£æ¡ˆ";
      profileClientNameEl.textContent = clientName;

      const profile = clientProfiles[clientName] || {};
      profileGenderEl.value = profile.gender || "";
      profileAgeEl.value = profile.age || "";
      profileInvestYearsEl.value = profile.investYears || "";
      profileTradingStyleEl.value = profile.tradingStyle || "";
      profileHobbiesEl.value = profile.hobbies || "";
      profileFamilyEl.value = profile.family || "";
      profileNoteEl.value = profile.note || "";

      clientProfileBackdrop.style.display = "flex";
    }

    function saveClientProfile() {
      if (!currentProfileClient) return;
      clientProfiles[currentProfileClient] = {
        gender: profileGenderEl.value,
        age: profileAgeEl.value.trim(),
        investYears: profileInvestYearsEl.value.trim(),
        tradingStyle: profileTradingStyleEl.value.trim(),
        hobbies: profileHobbiesEl.value.trim(),
        family: profileFamilyEl.value.trim(),
        note: profileNoteEl.value.trim()
      };
      saveClientProfiles();
      clientProfileBackdrop.style.display = "none";
      renderClientCards(); // æ›´æ–°å¡ç‰‡ä¸Šæ˜¾ç¤ºçš„æ¡£æ¡ˆä¿¡æ¯
    }

    function closeClientProfile() {
      clientProfileBackdrop.style.display = "none";
    }

    // åˆå§‹åŒ–
    loadHoldings();
    loadClientProfiles();
    renderAll();
  </script>
</body>
</html>
