<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>éŸ©å›½è‚¡ç¥¨å®¢æˆ·æŒä»“è¿½è¸ª</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft YaHei",sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #f3f4f6 40%, #e5e7eb 100%);
      color: #111827;
    }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .layout {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
    }

    .header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title {
      font-size: 22px;
      font-weight: 700;
      color: #0f172a;
    }
    .subtitle {
      font-size: 12px;
      color: #4b5563;
      margin-top: 4px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(37,99,235,0.06);
      border: 1px solid rgba(37,99,235,0.25);
      color: #1d4ed8;
      gap: 4px;
      font-weight: 500;
    }

    .grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 14px 16px;
      box-shadow: 0 12px 25px rgba(15,23,42,0.06);
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #111827;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .card-title span {
      font-size: 11px;
      color: #6b7280;
      font-weight: 400;
    }

    label {
      display: block;
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      border-radius: 9px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #111827;
      font-size: 13px;
      padding: 7px 10px;
      outline: none;
      transition: border-color .15s, box-shadow .15s, background .15s;
    }
    input:focus, select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.25);
      background: #ffffff;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform .05s, box-shadow .1s, filter .1s;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(135deg,#2563eb,#3b82f6);
      color: #f9fafb;
      box-shadow: 0 8px 18px rgba(37,99,235,0.35);
    }
    .btn-primary:hover { filter: brightness(1.03); }
    .btn-secondary {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #cbd5f5;
    }
    .btn-secondary:hover { border-color: #94a3b8; }
    .btn-ghost {
      background: #f9fafb;
      color: #4b5563;
      border: 1px solid #e5e7eb;
    }
    .btn-ghost:hover { border-color: #cbd5f5; }
    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .btn-sm { padding: 4px 10px; font-size: 11px; }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .switch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #6b7280;
    }
    .switch input {
      width: auto;
      height: auto;
      cursor: pointer;
    }

    /* é¡¶éƒ¨æ±‡æ€»åŒºï¼šæ¯ä¸ªå®¢æˆ·ä¸€å¼ å¡ç‰‡ */
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .summary-item {
      padding: 8px 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      gap: 6px;
    }
    .summary-client {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }
    .summary-rate {
      font-size: 12px;
      font-weight: 600;
    }
    .summary-rate.positive { color: #16a34a; }
    .summary-rate.negative { color: #dc2626; }
    .summary-line {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #4b5563;
    }
    .summary-line + .summary-line {
      margin-top: 2px;
    }
    .summary-label {
      color: #6b7280;
    }
    .summary-value.positive { color: #16a34a; font-weight: 600; }
    .summary-value.negative { color: #dc2626; font-weight: 600; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    thead {
      background: #f1f5f9;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      white-space: nowrap;
    }
    th {
      font-weight: 500;
      color: #6b7280;
    }
    td.t-left, th.t-left { text-align: left; }

    tbody tr:hover {
      background: #f9fafb;
    }

    .group-row td {
      background: #eef2ff;
      border-bottom-color: #c7d2fe;
      font-weight: 600;
      color: #1e293b;
    }

    .pill {
      padding: 0 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pill-gain { background: #dcfce7; color: #15803d; }
    .pill-loss { background: #fee2e2; color: #b91c1c; }
    .pill-neutral { background: #e5e7eb; color: #4b5563; }

    .tag-alert {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1d4ed8;
    }

    .row-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: nowrap;
    }

    .empty-tip {
      font-size: 12px;
      color: #6b7280;
      padding: 16px 0;
      text-align: center;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #6b7280;
    }

    .footer {
      margin-top: 16px;
      font-size: 10px;
      color: #9ca3af;
      text-align: right;
    }

    /* ==== AI è§£æå¼¹çª— ==== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      z-index: 40;
      display: none;
    }
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      pointer-events: none;
    }
    .modal-inner {
      pointer-events: auto;
      width: 100%;
      max-width: 460px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.45);
      border: 1px solid #e5e7eb;
      padding: 12px 14px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }
    .modal-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    .modal-body {
      max-height: 260px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.5;
      color: #374151;
      white-space: pre-wrap;
      border-top: 1px solid #e5e7eb;
      padding-top: 6px;
      margin-top: 4px;
    }
    .modal-footer {
      margin-top: 8px;
      text-align: right;
      font-size: 11px;
      color: #9ca3af;
    }
    .btn-ai {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #eef2ff;
      color: #3730a3;
      padding: 3px 10px;
      font-size: 11px;
      cursor: pointer;
    }
    .btn-ai:hover {
      border-color: #c7d2fe;
      background: #e0e7ff;
    }
  </style>
</head>
<body>
  <div class="layout">
    <header class="header">
      <div>
        <div class="title">éŸ©å›½è‚¡ç¥¨å®¢æˆ·æŒä»“è¿½è¸ª</div>
        <div class="subtitle">
          å®¢æˆ·æŒ‰å§“ååˆ†ç»„ç®¡ç†ï¼Œ<b>æ¯ä½å®¢æˆ·å•ç‹¬ç»Ÿè®¡æ€»æŠ•å…¥æˆæœ¬ / å½“å‰å¸‚å€¼ / æ€»ç›ˆäº / æ”¶ç›Šç‡</b>ï¼Œæ”¯æŒè‡ªåŠ¨åˆ·æ–° Naver è¡Œæƒ…ä¸å¯¼å‡ºæ”¶ç›Šæ—¥æŠ¥ï¼ˆæ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ä¸­ï¼‰ã€‚
        </div>
      </div>
      <div>
        <span class="tag">
          <span>ì‹œì¥</span>
          <strong>KOSPI / KOSDAQ</strong>
        </span>
      </div>
    </header>

    <main class="grid">
      <!-- å·¦ä¾§ï¼šæ–°å¢ / ç¼–è¾‘æŒä»“ -->
      <section class="card">
        <div class="card-title">
          æ–°å¢ / ä¿®æ”¹æŒä»“
          <span>Symbol ç¤ºä¾‹ï¼š005930.KSï¼ˆKOSPIï¼‰ã€353200.KQï¼ˆKOSDAQï¼‰</span>
        </div>

        <form id="holdForm">
          <input type="hidden" id="editId" />

          <label>å®¢æˆ·å§“å / åˆ†ç»„å</label>
          <input id="client" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ / æ‚Ÿç©ºç»„" required />

          <label style="margin-top:8px;">è‚¡ç¥¨åç§°</label>
          <input id="stockName" placeholder="ä¾‹å¦‚ï¼šì‚¼ì„±ì „ì / ë°•ì…€ë°”ì´ì˜¤" required />

          <label style="margin-top:8px;">è¯åˆ¸ä»£ç ï¼ˆå¯å¸¦ .KS / .KQï¼‰</label>
          <input id="symbol" placeholder="ä¾‹å¦‚ï¼š005930.KS / 323990.KQ" required />

          <div class="row" style="margin-top:8px;">
            <div>
              <label>æŒè‚¡æ•°é‡ï¼ˆè‚¡ï¼‰</label>
              <input id="quantity" type="number" min="1" step="1" required />
            </div>
            <div>
              <label>ä¹°å…¥ä»·æ ¼ï¼ˆâ‚©ï¼‰</label>
              <input id="cost" type="number" min="0" step="1" required />
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <div>
              <label>æ­¢æŸä»·ï¼ˆé€‰å¡«ï¼‰</label>
              <input id="stopLoss" type="number" min="0" step="1" />
            </div>
            <div>
              <label>æ­¢ç›ˆä»·ï¼ˆé€‰å¡«ï¼‰</label>
              <input id="takeProfit" type="number" min="0" step="1" />
            </div>
          </div>

          <div style="margin-top:10px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
            <button type="submit" class="btn btn-primary">
              <span id="submitLabel">ä¿å­˜æŒä»“</span>
            </button>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button type="button" id="resetBtn" class="btn btn-secondary btn-sm">æ¸…ç©ºè¡¨å•</button>
              <button type="button" id="clearAllBtn" class="btn btn-danger btn-sm">æ¸…ç©ºæ‰€æœ‰æŒä»“ï¼ˆæœ¬æœºï¼‰</button>
            </div>
          </div>

          <div style="margin-top:8px; font-size:11px; color:#6b7280;">
            æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ <span class="badge">localStorage</span> ä¸­ï¼Œä»…å¯¹æœ¬æœºå¯è§ã€‚<br/>
            å¦‚éœ€å¤šè®¾å¤‡åŒæ­¥ï¼Œå¯åç»­å‡çº§ä¸ºäº‘ç«¯ç‰ˆã€‚
          </div>
        </form>
      </section>

      <!-- å³ä¾§ï¼šæ±‡æ€» + æ˜ç»† -->
      <section class="card">
        <div class="card-title">
          æŒä»“æ¦‚è§ˆ Â· å®æ—¶æŠ¥ä»·
          <span>
            <span class="tag-alert">æ¯ä½å®¢æˆ·å•ç‹¬æ±‡æ€» Â· è‡ªåŠ¨åˆ·æ–° Naver è¡Œæƒ…</span>
          </span>
        </div>

        <div class="toolbar">
          <div class="toolbar-right">
            <button type="button" id="refreshBtn" class="btn btn-secondary btn-sm">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°è¡Œæƒ…</button>
            <div class="switch">
              <input type="checkbox" id="autoRefreshToggle" />
              <label for="autoRefreshToggle" style="margin:0;">è‡ªåŠ¨åˆ·æ–°</label>
            </div>
            <select id="intervalSelect" style="width:auto;">
              <option value="30" selected>30ç§’</option>
              <option value="60">60ç§’</option>
              <option value="120">120ç§’</option>
            </select>
          </div>
          <div class="toolbar-right">
            <button type="button" id="exportBtn" class="btn btn-ghost btn-sm">ğŸ“¤ å¯¼å‡ºæ”¶ç›Šæ—¥æŠ¥ï¼ˆCSVï¼‰</button>
          </div>
        </div>

        <!-- æ¯ä¸ªå®¢æˆ·ç‹¬ç«‹æ±‡æ€» -->
        <div id="summaryContainer" class="summary"></div>

        <div style="max-height:420px; overflow:auto; border-radius:10px; border:1px solid #e5e7eb; margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th class="t-left">å®¢æˆ·</th>
                <th class="t-left">è‚¡ç¥¨</th>
                <th>ä»£ç </th>
                <th>æ•°é‡</th>
                <th>æˆæœ¬ä»·</th>
                <th>æ­¢æŸ</th>
                <th>æ­¢ç›ˆ</th>
                <th>ç°ä»·</th>
                <th>å¸‚å€¼</th>
                <th>ç›ˆäº</th>
                <th>æ”¶ç›Šç‡</th>
                <th class="t-left">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <div id="emptyTip" class="empty-tip" style="display:none;">
          è¿˜æ²¡æœ‰å½•å…¥ä»»ä½•æŒä»“è®°å½•ï¼Œè¯·åœ¨å·¦ä¾§å¡«å†™å®¢æˆ·ä¸è‚¡ç¥¨ä¿¡æ¯åç‚¹å‡»â€œä¿å­˜æŒä»“â€ã€‚
        </div>

        <div class="footer">
          Data by Naver Finance Â· æ¯ä½ç”¨æˆ·æ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ä¸­ã€‚
        </div>
      </section>
    </main>

    <!-- AI è§£æå¼¹çª— -->
    <div id="aiBackdrop" class="modal-backdrop"></div>
    <div id="aiModal" class="modal" style="display:none;">
      <div class="modal-inner">
        <div class="modal-header">
          <div id="aiModalTitle" class="modal-title">AI è§£æå»ºè®®</div>
          <button type="button" id="aiModalClose" class="btn-ghost btn-sm">å…³é—­</button>
        </div>
        <div id="aiModalContent" class="modal-body"></div>
        <div class="modal-footer">
          ä»¥ä¸Šå†…å®¹ä¸ºç¨‹åºæ ¹æ®å½“å‰æŒä»“è‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "korea_portfolio_tracker_v1";

    const form = document.getElementById("holdForm");
    const editIdInput = document.getElementById("editId");
    const clientInput = document.getElementById("client");
    const stockNameInput = document.getElementById("stockName");
    const symbolInput = document.getElementById("symbol");
    const quantityInput = document.getElementById("quantity");
    const costInput = document.getElementById("cost");
    const stopLossInput = document.getElementById("stopLoss");
    const takeProfitInput = document.getElementById("takeProfit");
    const resetBtn = document.getElementById("resetBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const autoToggle = document.getElementById("autoRefreshToggle");
    const intervalSelect = document.getElementById("intervalSelect");
    const exportBtn = document.getElementById("exportBtn");
    const tableBody = document.getElementById("tableBody");
    const emptyTip = document.getElementById("emptyTip");
    const submitLabel = document.getElementById("submitLabel");
    const summaryContainer = document.getElementById("summaryContainer");

    // AI å¼¹çª—ç›¸å…³ DOM
    const aiBackdrop = document.getElementById("aiBackdrop");
    const aiModal = document.getElementById("aiModal");
    const aiModalTitle = document.getElementById("aiModalTitle");
    const aiModalContent = document.getElementById("aiModalContent");
    const aiModalClose = document.getElementById("aiModalClose");

    let holdings = [];
    let autoTimer = null;

    function loadHoldings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        holdings = raw ? JSON.parse(raw) : [];
      } catch (e) {
        holdings = [];
      }
    }

    function saveHoldings() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(holdings));
      renderAll();
    }

    function formatNumber(n) {
      return n.toLocaleString("ko-KR");
    }

    function formatPercent(v) {
      const n = Number(v);
      if (!isFinite(n)) return "0.00%";
      const s = n.toFixed(2) + "%";
      if (n > 0) return "+" + s;
      return s;
    }

    function groupByClient(list) {
      const map = {};
      list.forEach(h => {
        const key = h.client || "æœªå‘½åå®¢æˆ·";
        if (!map[key]) map[key] = [];
        map[key].push(h);
      });
      return map;
    }

    // === AI å¼¹çª— ===
    function openAiModal(title, content) {
      aiModalTitle.textContent = title;
      aiModalContent.textContent = content;
      aiBackdrop.style.display = "block";
      aiModal.style.display = "flex";
    }

    function closeAiModal() {
      aiBackdrop.style.display = "none";
      aiModal.style.display = "none";
    }

    aiBackdrop.addEventListener("click", closeAiModal);
    aiModalClose.addEventListener("click", closeAiModal);

    // å•åªè‚¡ç¥¨è§£æ
    function generateHoldingAdvice(h) {
      const qty = Number(h.quantity) || 0;
      const cost = Number(h.cost) || 0;
      const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
      const value = qty * cur;
      const pnl = value - qty * cost;
      const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

      const stopLoss = h.stopLoss ? Number(h.stopLoss) : null;
      const takeProfit = h.takeProfit ? Number(h.takeProfit) : null;

      const lines = [];

      lines.push(
        `ã€æŒä»“æ¦‚å†µã€‘\n` +
        `å®¢æˆ·ï¼š${h.client}\n` +
        `æ ‡çš„ï¼š${h.stockName}ï¼ˆ${h.symbol}ï¼‰\n` +
        `æŒè‚¡æ•°é‡ï¼š${formatNumber(qty)} è‚¡\n` +
        `æŒä»“æˆæœ¬ï¼šâ‚© ${formatNumber(cost)}\n` +
        `å½“å‰ä»·æ ¼ï¼šâ‚© ${formatNumber(cur)}\n` +
        `æµ®åŠ¨ç›ˆäºï¼šâ‚© ${formatNumber(pnl)}ï¼ˆ${formatPercent(rate)}ï¼‰`
      );

      let strategy = "ã€ç­–ç•¥å»ºè®®ã€‘\n";
      if (rate >= 15) {
        strategy +=
          "ç›®å‰å¤„äºè¾ƒå¤§ç›ˆåˆ©åŒºé—´ï¼Œå»ºè®®åˆ†æ‰¹é”å®šæ”¶ç›Šï¼šå¯ä»¥å…ˆå…‘ç°ä¸€éƒ¨åˆ†ä»“ä½ï¼Œå°†åˆ©æ¶¦è½è¢‹ï¼Œå…¶ä½™ä»“ä½æ ¹æ®åç»­è¶‹åŠ¿å†å†³å®šæ˜¯å¦ç»§ç»­æŒæœ‰ã€‚";
      } else if (rate >= 5) {
        strategy +=
          "å½“å‰å¤„äºæ¸©å’Œç›ˆåˆ©çŠ¶æ€ï¼Œå¯ä»¥æ ¹æ®ä¸ªäººé£é™©åå¥½è®¾ç½®è·Ÿè¸ªæ­¢ç›ˆï¼šè‹¥çŸ­æœŸæ”¾é‡ä¸Šå†²ï¼Œå¯ä»¥å°è¯•å†å¤šçœ‹ä¸€ä¸¤ä¸ªäº¤æ˜“æ—¥ï¼›è‹¥æ”¾é‡æ»æ¶¨æˆ–è·Œç ´çŸ­æœŸå‡çº¿ï¼Œå»ºè®®åŠæ—¶å‡ä»“ã€‚";
      } else if (rate > -5) {
        strategy +=
          "ç›®å‰ç›ˆäºæ³¢åŠ¨è¾ƒå°ï¼Œå±äºæ­£å¸¸éœ‡è¡åŒºé—´ã€‚å»ºè®®é‡ç‚¹å…³æ³¨åŸºæœ¬é¢å’Œæ¿å—æƒ…ç»ªå˜åŒ–ï¼Œä¸å¿…è¿‡åº¦é¢‘ç¹æ“ä½œï¼Œç­‰å¾…æ›´æ˜ç¡®çš„æ–¹å‘å†åšå†³ç­–ã€‚";
      } else if (rate > -15) {
        strategy +=
          "æµ®äºåœ¨å¯æ‰¿å—èŒƒå›´å†…ï¼Œå»ºè®®ç»“åˆåŸºæœ¬é¢åˆ¤æ–­ï¼šè‹¥é€»è¾‘æœªå˜ã€è¶‹åŠ¿ä»åœ¨ï¼Œå¯è€ƒè™‘ä¸åŠ ä»“ã€è½»ä»“è§‚æœ›ï¼›è‹¥å‡ºç°åˆ©ç©ºæˆ–æŠ€æœ¯é¢èµ°åï¼Œè·Œç ´å…³é”®æ”¯æ’‘ä½æ—¶è¦æœæ–­æ­¢æŸã€‚";
      } else {
        strategy +=
          "æµ®äºå¹…åº¦è¾ƒå¤§ï¼Œéœ€è¦è°¨æ…è¯„ä¼°æ˜¯å¦ç»§ç»­æŒæœ‰ï¼šé¦–å…ˆç¡®è®¤æ˜¯å¦å‡ºç°åŸºæœ¬é¢æ¶åŒ–æˆ–é¢˜æé™æ¸©ï¼›è‹¥ç¡®è®¤é€»è¾‘ç ´åï¼Œå»ºè®®åˆ©ç”¨åå¼¹æœºä¼šå‡ä»“æˆ–æ­¢æŸç¦»åœºï¼Œé¿å…äºæŸè¿›ä¸€æ­¥æ‰©å¤§ã€‚";
      }
      lines.push(strategy);

      if (stopLoss || takeProfit) {
        let extra = "ã€è®¡åˆ’ä»·ä½ã€‘\n";
        if (stopLoss) {
          extra += `æ­¢æŸä»·ï¼šâ‚© ${formatNumber(stopLoss)} `;
          if (cur <= stopLoss) {
            extra += "ï¼ˆå·²æ¥è¿‘/è·Œç ´æ­¢æŸä»·ï¼Œå»ºè®®ä¼˜å…ˆç¡®è®¤æ˜¯å¦æ‰§è¡ŒåŸæœ‰çºªå¾‹ã€‚ï¼‰\n";
          } else {
            extra += "ï¼ˆå°šæœªè§¦åŠæ­¢æŸï¼Œç»§ç»­æŒ‰è®¡åˆ’è§‚å¯Ÿã€‚ï¼‰\n";
          }
        }
        if (takeProfit) {
          extra += `æ­¢ç›ˆä»·ï¼šâ‚© ${formatNumber(takeProfit)} `;
          if (cur >= takeProfit) {
            extra += "ï¼ˆå·²æ¥è¿‘/è¾¾åˆ°æ­¢ç›ˆä»·ï¼Œå¯æŒ‰åŸè®¡åˆ’è€ƒè™‘åˆ†æ‰¹å…‘ç°æ”¶ç›Šã€‚ï¼‰\n";
          } else {
            extra += "ï¼ˆå°šæœªåˆ°è¾¾æ­¢ç›ˆä½ï¼Œå¯æ ¹æ®ç›˜ä¸­æ”¾é‡æƒ…å†µçµæ´»è°ƒæ•´ã€‚ï¼‰\n";
          }
        }
        lines.push(extra.trimEnd());
      }

      lines.push(
        "ã€é£é™©æç¤ºã€‘\n" +
        "ä»¥ä¸Šä¸ºç³»ç»Ÿæ ¹æ®å½“å‰ä»·æ ¼å’Œç›ˆäºåŒºé—´è‡ªåŠ¨ç”Ÿæˆçš„å‚è€ƒæ„è§ï¼Œæœªç»¼åˆä¸ªè‚¡æ‰€æœ‰åŸºæœ¬é¢ä¸èµ„é‡‘ä¿¡æ¯ï¼Œä¸æ„æˆä»»ä½•ä¿è¯æˆ–æ‰¿è¯ºï¼Œæœ€ç»ˆä¹°å–è¯·ç»“åˆæ‚¨çš„èµ„é‡‘çŠ¶å†µä¸é£é™©æ‰¿å—èƒ½åŠ›ç‹¬ç«‹å†³ç­–ã€‚"
      );

      return lines.join("\n\n");
    }

    // å•ä¸ªå®¢æˆ·æ•´ä½“è§£æ
    function generateClientAdvice(clientName, list) {
      let totalCost = 0;
      let totalValue = 0;
      list.forEach(h => {
        const qty = Number(h.quantity) || 0;
        const cost = Number(h.cost) || 0;
        const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
        totalCost += qty * cost;
        totalValue += qty * cur;
      });
      const pnl = totalValue - totalCost;
      const rate = totalCost > 0 ? (pnl / totalCost) * 100 : 0;

      const lines = [];

      lines.push(
        `ã€å®¢æˆ·æ€»ä½“æ¦‚å†µã€‘\n` +
        `å®¢æˆ·ï¼š${clientName}\n` +
        `æ€»æŠ•å…¥æˆæœ¬ï¼šâ‚© ${formatNumber(totalCost)}\n` +
        `å½“å‰å¸‚å€¼ï¼šâ‚© ${formatNumber(totalValue)}\n` +
        `æ€»ä½“æµ®åŠ¨ç›ˆäºï¼šâ‚© ${formatNumber(pnl)}ï¼ˆ${formatPercent(rate)}ï¼‰\n` +
        `æŒä»“æ ‡çš„æ•°é‡ï¼š${list.length} åª`
      );

      let overall = "ã€æ•´ä½“ä»“ä½å»ºè®®ã€‘\n";
      if (rate >= 15) {
        overall +=
          "æ•´ä½“æµ®ç›ˆæ°´å¹³è¾ƒé«˜ï¼Œå»ºè®®é€æ­¥è½è¢‹ä¸ºä¸»ï¼šå¯æŒ‰ç…§ä¸ªè‚¡å¼ºå¼±åˆ†æ‰¹å‡ä»“ï¼Œä¼˜å…ˆå…‘ç°è¿‘æœŸæ¶¨å¹…è¿‡å¿«ã€åŸºæœ¬é¢å¼¹æ€§æœ‰é™çš„æ ‡çš„ï¼Œä¸ºåç»­è¡Œæƒ…é¢„ç•™ç°é‡‘å¼¹è¯ã€‚";
      } else if (rate >= 5) {
        overall +=
          "æ•´ä½“ç›ˆåˆ©è‰¯å¥½ï¼Œå¯ä»¥åœ¨ä¿æŒåŸºæœ¬ä»“ä½çš„å‰æä¸‹ï¼Œé’ˆå¯¹æ¶¨å¹…è¿‡å¤§çš„ä¸ªè‚¡é€‚å½“å‡ä»“ï¼ŒæŠŠè´¦é¢æ”¶ç›Šè½¬ä¸ºå·²å®ç°æ”¶ç›Šï¼ŒåŒæ—¶ä¼˜åŒ–æŒä»“ç»“æ„ã€‚";
      } else if (rate > -5) {
        overall +=
          "æ•´ä½“ç›ˆäºåŸºæœ¬æŒå¹³ï¼Œå±äºæ­£å¸¸æ³¢åŠ¨åŒºé—´ã€‚å»ºè®®ä»¥è°ƒä»“ä¼˜åŒ–ä¸ºä¸»ï¼šé€‚å½“é™ä½å¼±åŠ¿æˆ–é€»è¾‘ä¸æ¸…çš„ä¸ªè‚¡ä»“ä½ï¼ŒæŠŠèµ„é‡‘é›†ä¸­åˆ°ç¡®å®šæ€§æ›´é«˜çš„æ ¸å¿ƒæ ‡çš„ä¸Šã€‚";
      } else if (rate > -15) {
        overall +=
          "ç»„åˆå¤„äºå¯æ§å›æ’¤åŒºé—´ï¼Œå»ºè®®å°½å¿«æ¢³ç†æŒä»“é€»è¾‘ï¼šå¯¹åŸºæœ¬é¢è‰¯å¥½ã€ä¼°å€¼åˆç†çš„å“ç§å¯è€å¿ƒæŒæœ‰ï¼›å¯¹é¢˜æè¾¹ç¼˜ã€æˆäº¤ä½è¿·çš„å“ç§ï¼Œå»ºè®®åˆ©ç”¨åå¼¹æœºä¼šåšå‡ä»“å¤„ç†ã€‚";
      } else {
        overall +=
          "ç»„åˆå›æ’¤å¹…åº¦è¾ƒå¤§ï¼Œéœ€é‡ç‚¹æ§åˆ¶é£é™©ï¼šä¸€æ–¹é¢è€ƒè™‘é™ä½æ•´ä½“ä»“ä½ï¼ŒæŠŠéƒ¨åˆ†èµ„é‡‘è½¬ä¸ºç°é‡‘ä»¥é™ä½æ³¢åŠ¨ï¼›å¦ä¸€æ–¹é¢ä¼˜å…ˆæ¸…ç†é€»è¾‘ä¸å†æˆç«‹æˆ–æµåŠ¨æ€§è¾ƒå·®çš„ä¸ªè‚¡ï¼Œé¿å…â€œè¶Šå¥—è¶Šæ·±â€ã€‚";
      }
      lines.push(overall);

      if (list.length >= 1) {
        const biggest = [...list].sort((a, b) => {
          const qa = Number(a.quantity) || 0;
          const ca = Number(a.cost) || 0;
          const pa = a.currentPrice != null ? Number(a.currentPrice) : ca;
          const va = qa * pa;
          const qb = Number(b.quantity) || 0;
          const cb = Number(b.cost) || 0;
          const pb = b.currentPrice != null ? Number(b.currentPrice) : cb;
          const vb = qb * pb;
          return vb - va;
        })[0];

        const bq = Number(biggest.quantity) || 0;
        const bc = Number(biggest.cost) || 0;
        const bp = biggest.currentPrice != null ? Number(biggest.currentPrice) : bc;
        const bv = bq * bp;
        const weight = totalValue > 0 ? (bv / totalValue) * 100 : 0;

        lines.push(
          "ã€æŒä»“ç»“æ„æç¤ºã€‘\n" +
          `å½“å‰ä»“ä½ä¸­æƒé‡æœ€é«˜çš„æ ‡çš„æ˜¯ï¼š${biggest.stockName}ï¼ˆ${biggest.symbol}ï¼‰ï¼Œçº¦å ç»„åˆå¸‚å€¼çš„ ${weight.toFixed(1)}%ã€‚\n` +
          `å»ºè®®å…³æ³¨è¯¥æ ‡çš„çŸ­æœŸæ³¢åŠ¨å¯¹æ•´ä½“èµ„äº§æ›²çº¿çš„å½±å“ï¼Œå¿…è¦æ—¶é€šè¿‡æ§åˆ¶è¯¥æ ‡çš„ä»“ä½æ¥å¹³æ»‘æ•´ä½“æ³¢åŠ¨ã€‚`
        );
      }

      lines.push(
        "ã€é£é™©æç¤ºã€‘\n" +
        "ä»¥ä¸Šä¸ºç¨‹åºæ ¹æ®å½“å‰ç»„åˆç›ˆäºä¸æŒä»“ç»“æ„è‡ªåŠ¨ç”Ÿæˆçš„å‚è€ƒæ„è§ï¼Œæœªå……åˆ†è¦†ç›–æ‰€æœ‰ä¸ªè‚¡çš„åŸºæœ¬é¢ä¸å®è§‚å› ç´ ï¼Œä»…ä¾›äº¤æµå‚è€ƒï¼Œæœ€ç»ˆæŠ•èµ„å†³ç­–è¯·ç»“åˆå®é™…æƒ…å†µè°¨æ…åˆ¤æ–­ã€‚"
      );

      return lines.join("\n\n");
    }

    // é¡¶éƒ¨æ±‡æ€»ï¼šæ¯ä¸ªå®¢æˆ·ä¸€å¼ å¡ç‰‡ + AIæŒ‰é’®
    function renderSummary() {
      summaryContainer.innerHTML = "";
      const groups = groupByClient(holdings);
      const clients = Object.keys(groups).sort();

      if (!clients.length) {
        summaryContainer.innerHTML =
          '<div class="summary-item"><div class="summary-client" style="font-size:12px;color:#6b7280;">æš‚æ— æŒä»“è®°å½•</div></div>';
        return;
      }

      clients.forEach(clientName => {
        const list = groups[clientName];
        let totalCost = 0;
        let totalValue = 0;

        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          totalCost += qty * cost;
          totalValue += qty * cur;
        });

        const pnl = totalValue - totalCost;
        const rate = totalCost > 0 ? (pnl / totalCost) * 100 : 0;

        const card = document.createElement("div");
        card.className = "summary-item";

        const rateClass = pnl > 0 ? "positive" : pnl < 0 ? "negative" : "";
        const pnlClass = pnl > 0 ? "summary-value positive" :
                         pnl < 0 ? "summary-value negative" :
                         "summary-value";

        card.innerHTML = `
          <div class="summary-header">
            <div class="summary-client">${clientName}</div>
            <div class="summary-rate ${rateClass}">${formatPercent(rate)}</div>
          </div>
          <div class="summary-line">
            <span class="summary-label">æ€»æŠ•å…¥æˆæœ¬</span>
            <span>â‚© ${formatNumber(totalCost)}</span>
          </div>
          <div class="summary-line">
            <span class="summary-label">å½“å‰å¸‚å€¼</span>
            <span>â‚© ${formatNumber(totalValue)}</span>
          </div>
          <div class="summary-line">
            <span class="summary-label">æ€»ç›ˆäº</span>
            <span class="${pnlClass}">â‚© ${formatNumber(pnl)}</span>
          </div>
          <div class="summary-line" style="margin-top:4px; justify-content:flex-end;">
            <button type="button" class="btn-ai ai-client-btn">AIè§£æå»ºè®®</button>
          </div>
        `;

        const aiBtn = card.querySelector(".ai-client-btn");
        aiBtn.addEventListener("click", () => {
          const text = generateClientAdvice(clientName, list);
          openAiModal(`${clientName} Â· å®¢æˆ·æ•´ä½“æŒä»“è§£æ`, text);
        });

        summaryContainer.appendChild(card);
      });
    }

    function renderTable() {
      tableBody.innerHTML = "";
      if (!holdings.length) {
        emptyTip.style.display = "block";
        return;
      }
      emptyTip.style.display = "none";

      const groups = groupByClient(holdings);
      const clients = Object.keys(groups).sort();

      clients.forEach(clientName => {
        const list = groups[clientName];

        let clientCost = 0;
        let clientValue = 0;
        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          clientCost += qty * cost;
          clientValue += qty * cur;
        });
        const clientPnl = clientValue - clientCost;
        const clientRate = clientCost > 0 ? (clientPnl / clientCost) * 100 : 0;

        const gtr = document.createElement("tr");
        gtr.className = "group-row";
        const gtd = document.createElement("td");
        gtd.colSpan = 12;
        gtd.className = "t-left";
        gtd.textContent =
          `${clientName}ï½œæŠ•å…¥ â‚© ${formatNumber(clientCost)}ï½œå¸‚å€¼ â‚© ${formatNumber(clientValue)}ï½œç›ˆäº â‚© ${formatNumber(clientPnl)}ï¼ˆ${formatPercent(clientRate)}ï¼‰`;
        gtr.appendChild(gtd);
        tableBody.appendChild(gtr);

        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          const value = qty * cur;
          const pnl = value - qty * cost;
          const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

          const tr = document.createElement("tr");

          if (h.currentPrice != null) {
            const cp = Number(h.currentPrice);
            if (h.stopLoss && cp <= Number(h.stopLoss)) {
              tr.style.background = "#fee2e2";
            } else if (h.takeProfit && cp >= Number(h.takeProfit)) {
              tr.style.background = "#dcfce7";
            }
          }

          const tdClient = document.createElement("td");
          tdClient.className = "t-left";
          tdClient.textContent = h.client;

          const tdStock = document.createElement("td");
          tdStock.className = "t-left";
          tdStock.textContent = h.stockName;

          const tdSymbol = document.createElement("td");
          tdSymbol.textContent = h.symbol;

          const tdQty = document.createElement("td");
          tdQty.textContent = formatNumber(qty);

          const tdCost = document.createElement("td");
          tdCost.textContent = formatNumber(cost);

          const tdSL = document.createElement("td");
          tdSL.textContent = h.stopLoss ? formatNumber(Number(h.stopLoss)) : "-";

          const tdTP = document.createElement("td");
          tdTP.textContent = h.takeProfit ? formatNumber(Number(h.takeProfit)) : "-";

          const tdCur = document.createElement("td");
          tdCur.textContent = h.currentPrice != null ? formatNumber(Number(h.currentPrice)) : "-";

          const tdVal = document.createElement("td");
          tdVal.textContent = formatNumber(value);

          const tdPnl = document.createElement("td");
          tdPnl.textContent = formatNumber(pnl);
          tdPnl.style.color = pnl > 0 ? "#16a34a" : pnl < 0 ? "#dc2626" : "#111827";
          tdPnl.style.fontWeight = "600";

          const tdRate = document.createElement("td");
          const pill = document.createElement("span");
          pill.className =
            "pill " +
            (rate > 0 ? "pill-gain" : rate < 0 ? "pill-loss" : "pill-neutral");
          pill.textContent = formatPercent(rate);
          tdRate.appendChild(pill);

          const tdActions = document.createElement("td");
          tdActions.className = "t-left";
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "row-actions";

          const aiBtn = document.createElement("button");
          aiBtn.type = "button";
          aiBtn.className = "btn-ai";
          aiBtn.textContent = "AIè§£æ";
          aiBtn.onclick = () => {
            const text = generateHoldingAdvice(h);
            openAiModal(`${h.client} Â· ${h.stockName}ï¼ˆ${h.symbol}ï¼‰`, text);
          };

          const oneRefreshBtn = document.createElement("button");
          oneRefreshBtn.type = "button";
          oneRefreshBtn.className = "btn btn-ghost btn-sm";
          oneRefreshBtn.textContent = "ğŸ”„";
          oneRefreshBtn.title = "åˆ·æ–°è¯¥è‚¡ç¥¨è¡Œæƒ…";
          oneRefreshBtn.onclick = () => refreshPrices([h.symbol]);

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-ghost btn-sm";
          editBtn.textContent = "ç¼–è¾‘";
          editBtn.onclick = () => startEdit(h.id);

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-danger btn-sm";
          delBtn.textContent = "åˆ é™¤";
          delBtn.onclick = () => deleteHolding(h.id);

          actionsDiv.appendChild(aiBtn);
          actionsDiv.appendChild(oneRefreshBtn);
          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(delBtn);
          tdActions.appendChild(actionsDiv);

          tr.appendChild(tdClient);
          tr.appendChild(tdStock);
          tr.appendChild(tdSymbol);
          tr.appendChild(tdQty);
          tr.appendChild(tdCost);
          tr.appendChild(tdSL);
          tr.appendChild(tdTP);
          tr.appendChild(tdCur);
          tr.appendChild(tdVal);
          tr.appendChild(tdPnl);
          tr.appendChild(tdRate);
          tr.appendChild(tdActions);

          tableBody.appendChild(tr);
        });
      });
    }

    function renderAll() {
      renderSummary();
      renderTable();
    }

    function resetForm() {
      editIdInput.value = "";
      submitLabel.textContent = "ä¿å­˜æŒä»“";
      form.reset();
    }

    function startEdit(id) {
      const h = holdings.find(x => x.id === id);
      if (!h) return;
      editIdInput.value = h.id;
      clientInput.value = h.client;
      stockNameInput.value = h.stockName;
      symbolInput.value = h.symbol;
      quantityInput.value = h.quantity;
      costInput.value = h.cost;
      stopLossInput.value = h.stopLoss ?? "";
      takeProfitInput.value = h.takeProfit ?? "";
      submitLabel.textContent = "ä¿å­˜ä¿®æ”¹";
    }

    function deleteHolding(id) {
      if (!confirm("ç¡®å®šåˆ é™¤è¯¥æ¡æŒä»“è®°å½•å—ï¼Ÿ")) return;
      holdings = holdings.filter(h => h.id !== id);
      saveHoldings();
      resetForm();
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const client = clientInput.value.trim();
      const stockName = stockNameInput.value.trim();
      const symbol = symbolInput.value.trim();
      const quantity = Number(quantityInput.value);
      const cost = Number(costInput.value);
      const stopLoss = stopLossInput.value ? Number(stopLossInput.value) : null;
      const takeProfit = takeProfitInput.value ? Number(takeProfitInput.value) : null;

      if (!client || !stockName || !symbol || !quantity || !cost) {
        alert("è¯·å®Œæ•´å¡«å†™å¿…å¡«é¡¹ã€‚");
        return;
      }

      const id = editIdInput.value;
      if (id) {
        const idx = holdings.findIndex(h => h.id === id);
        if (idx >= 0) {
          holdings[idx] = {
            ...holdings[idx],
            client, stockName, symbol,
            quantity, cost, stopLoss, takeProfit
          };
        }
      } else {
        holdings.push({
          id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          client,
          stockName,
          symbol,
          quantity,
          cost,
          stopLoss,
          takeProfit,
          currentPrice: null,
          updatedAt: null
        });
      }
      saveHoldings();
      resetForm();
    });

    resetBtn.addEventListener("click", () => {
      resetForm();
    });

    clearAllBtn.addEventListener("click", () => {
      if (!confirm("ç¡®å®šæ¸…ç©ºæœ¬æœºæ‰€æœ‰æŒä»“è®°å½•å—ï¼Ÿ")) return;
      holdings = [];
      saveHoldings();
      resetForm();
    });

    function setAutoRefresh(on) {
      if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
      }
      if (on) {
        const sec = Number(intervalSelect.value) || 60;
        autoTimer = setInterval(() => {
          if (holdings.length) refreshPrices();
        }, sec * 1000);
      }
    }

    autoToggle.addEventListener("change", () => {
      setAutoRefresh(autoToggle.checked);
      if (autoToggle.checked && holdings.length) {
        refreshPrices();
      }
    });

    intervalSelect.addEventListener("change", () => {
      if (autoToggle.checked) setAutoRefresh(true);
    });

    refreshBtn.addEventListener("click", () => {
      refreshPrices();
    });

    // æ‰¹é‡åˆ·æ–°è¡Œæƒ…ï¼ˆåç«¯ /api/prices ä½¿ç”¨ Naverï¼‰
    async function refreshPrices(symbolsOverride) {
      if (!holdings.length && !symbolsOverride) return;

      let symbols;
      if (symbolsOverride && symbolsOverride.length) {
        symbols = Array.from(new Set(symbolsOverride));
      } else {
        symbols = Array.from(new Set(holdings.map(h => h.symbol)));
      }

      try {
        const res = await fetch("/api/prices", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ symbols })
        });
        if (!res.ok) {
          console.error("è¡Œæƒ…åˆ·æ–°å¤±è´¥:", await res.text());
          return;
        }
        const data = await res.json();
        const now = new Date().toISOString();

        holdings.forEach(h => {
          const info = data[h.symbol] || data[h.symbol.toUpperCase()];
          if (info && info.ok) {
            h.currentPrice = Number(info.price);
            h.updatedAt = now;
          }
        });
        saveHoldings();
      } catch (e) {
        console.error("åˆ·æ–°è¡Œæƒ…å¼‚å¸¸:", e);
      }
    }

    exportBtn.addEventListener("click", () => {
      if (!holdings.length) {
        alert("å½“å‰æ²¡æœ‰ä»»ä½•æŒä»“è®°å½•å¯å¯¼å‡ºã€‚");
        return;
      }
      const rows = [];
      rows.push([
        "å®¢æˆ·",
        "è‚¡ç¥¨",
        "ä»£ç ",
        "æ•°é‡",
        "æˆæœ¬ä»·",
        "ç°ä»·",
        "å¸‚å€¼",
        "ç›ˆäº",
        "æ”¶ç›Šç‡(%)",
        "æ­¢æŸ",
        "æ­¢ç›ˆ",
        "æ›´æ–°æ—¶é—´"
      ]);

      holdings.forEach(h => {
        const qty = Number(h.quantity) || 0;
        const cost = Number(h.cost) || 0;
        const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
        const val = qty * cur;
        const pnl = val - qty * cost;
        const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

        rows.push([
          h.client,
          h.stockName,
          h.symbol,
          qty,
          cost,
          cur,
          val,
          pnl,
          rate.toFixed(2),
          h.stopLoss ?? "",
          h.takeProfit ?? "",
          h.updatedAt ? new Date(h.updatedAt).toLocaleString("zh-CN") : ""
        ]);
      });

      rows.push([]);
      rows.push(["=== æŒ‰å®¢æˆ·æ±‡æ€» ==="]);
      const groups = groupByClient(holdings);
      Object.keys(groups).forEach(name => {
        const list = groups[name];
        let costSum = 0, valSum = 0;
        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          costSum += qty * cost;
          valSum += qty * cur;
        });
        const pnl = valSum - costSum;
        const rate = costSum > 0 ? (pnl / costSum) * 100 : 0;
        rows.push([
          name,
          "",
          "",
          "",
          "",
          "",
          valSum,
          pnl,
          rate.toFixed(2)
        ]);
      });

      const csv = rows
        .map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(","))
        .join("\r\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2,"0");
      const d = String(now.getDate()).padStart(2,"0");
      a.href = url;
      a.download = `korea_portfolio_daily_${y}${m}${d}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    loadHoldings();
    renderAll();
  </script>
</body>
</html>
