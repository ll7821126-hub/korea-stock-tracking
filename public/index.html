<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>éŸ©å›½è‚¡å¸‚å®¢æˆ·æŒä»“è·Ÿè¸ªä¸æ­¢ç›ˆæ­¢æŸé¢„è­¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --primary: #2563eb;
      --primary-soft: #e0edff;
      --danger: #ef4444;
      --text-main: #111827;
      --text-sub: #6b7280;
      --gain: #16a34a;
      --loss: #dc2626;
      --radius-lg: 16px;
      --radius-md: 10px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
        "Helvetica Neue",Arial,"Noto Sans CJK SC","Malgun Gothic",sans-serif;
      background: radial-gradient(circle at top,#e5edff,#f9fafb 55%,#f3f4f6);
      color: var(--text-main);
    }
    .container { max-width: 1180px; margin: 0 auto; }
    header { margin-bottom: 16px; }
    header h1 {
      margin: 0;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header h1 span {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
    }
    header p {
      margin: 6px 0 0;
      font-size: 13px;
      color: var(--text-sub);
    }
    .layout {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 18px 36px rgba(15,23,42,0.08);
      padding: 16px 18px;
    }
    .card-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .card-subtitle {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 10px;
    }
    form { display: grid; gap: 8px; }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .form-row-3 {
      display: grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: 8px;
    }
    @media (max-width: 520px) {
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
    }
    label {
      display: block;
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
      background: #f9fafb;
      outline: none;
    }
    input:focus {
      border-color: var(--primary);
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.15);
    }
    .help-text {
      font-size: 11px;
      color: var(--text-sub);
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg,#2563eb,#1d4ed8);
      color: #ffffff;
      font-weight: 500;
      box-shadow: 0 10px 24px rgba(37,99,235,0.35);
    }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-ghost { background: transparent; color: var(--text-sub); padding-inline: 8px; }
    .btn-danger-outline {
      background: #fef2f2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }
    button:active { transform: translateY(1px); box-shadow: none; }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4,1fr);
      gap: 10px;
    }
    @media (max-width: 780px) {
      .summary-grid { grid-template-columns: repeat(2,1fr); }
    }
    .summary-item {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 8px 10px;
      background: linear-gradient(145deg,#ffffff,#f7f8fc);
    }
    .summary-label { font-size: 11px; color: var(--text-sub); margin-bottom: 3px; }
    .summary-value { font-size: 14px; font-weight: 600; }
    .summary-value.gain { color: var(--gain); }
    .summary-value.loss { color: var(--loss); }
    .summary-footer {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .table-wrapper {
      margin-top: 10px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: #ffffff;
      overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead { background: #f3f4f6; }
    th, td {
      padding: 7px 9px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      white-space: nowrap;
    }
    th { font-size: 11px; font-weight: 600; color: #4b5563; }
    td { color: #111827; }
    th.t-left, td.t-left { text-align: left; }
    tbody tr:nth-child(even) { background: #fafafa; }

    tr.alert-loss { background: #fef2f2 !important; }
    tr.alert-profit { background: #ecfdf3 !important; }

    .pill {
      display: inline-flex;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
    }
    .pill-gain { background: #dcfce7; color: #15803d; }
    .pill-loss { background: #fee2e2; color: #b91c1c; }
    .pill-neutral { background: #e5e7eb; color: #4b5563; }

    .actions { display: flex; justify-content: flex-end; gap: 4px; }
    .actions button { padding: 4px 8px; font-size: 11px; }

    .empty-tip {
      text-align: center;
      font-size: 12px;
      color: var(--text-sub);
      padding: 30px 10px;
    }
    .footer-note {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }
    .powered {
      margin-top: 18px;
      font-size: 11px;
      color: var(--text-sub);
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>
        éŸ©å›½è‚¡å¸‚å®¢æˆ·æŒä»“å®æ—¶è·Ÿè¸ª
        <span>KOSPI / KOSDAQ æ­¢ç›ˆæ­¢æŸé¢„è­¦</span>
      </h1>
      <p>å®¢æˆ·æŠŠæŒä»“å‘ç»™ä½ ï¼Œä½ ç»Ÿä¸€ç™»è®°ï¼›ç³»ç»ŸæŒ‰éŸ©å›½å®æ—¶è¡Œæƒ…è‡ªåŠ¨å¯¹æ¯”æ­¢ç›ˆ/æ­¢æŸï¼Œæé†’ä½ æ“ä½œã€‚</p>
    </header>

    <div class="layout">
      <!-- å·¦ä¾§ï¼šå½•å…¥è¡¨å• -->
      <section class="card">
        <div class="card-title">
          <span>æ–°å¢ / ä¿®æ”¹æŒä»“</span>
          <span style="font-size:10px;color:var(--text-sub);">åªå¯¹ä½ è‡ªå·±å¯è§ï¼Œå®¢æˆ·å½¼æ­¤çœ‹ä¸åˆ°</span>
        </div>
        <div class="card-subtitle">
          symbol å¡«éŸ©å›½è¡Œæƒ…ç”¨çš„ä»£ç ï¼šKOSPI = ä»£ç  + .KSï¼ˆ005930.KSï¼‰ï¼ŒKOSDAQ = ä»£ç  + .KQï¼ˆ091990.KQï¼‰ã€‚
        </div>

        <form id="holding-form">
          <input type="hidden" id="editingId" />

          <div class="form-row">
            <div>
              <label for="client">å®¢æˆ·å§“å / æ˜µç§°</label>
              <input id="client" type="text" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ / ê¹€ì² ìˆ˜" required />
            </div>
            <div>
              <label for="stockName">è‚¡ç¥¨åç§°</label>
              <input id="stockName" type="text" placeholder="ä¾‹å¦‚ï¼šì‚¼ì„±ì „ì" required />
            </div>
          </div>

          <div class="form-row">
            <div>
              <label for="symbol">è‚¡ç¥¨ä»£ç ï¼ˆç”¨äºéŸ©å›½è¡Œæƒ…ï¼‰</label>
              <input id="symbol" type="text"
                     placeholder="ä¾‹å¦‚ï¼š005930.KSï¼ˆä¸‰æ˜Ÿì „ìï¼‰ã€000660.KSï¼ˆSKí•˜ì´ë‹‰ìŠ¤ï¼‰"
                     required />
            </div>
            <div>
              <label for="quantity">æŒè‚¡æ•°é‡</label>
              <input id="quantity" type="number" min="1" step="1" placeholder="100" required />
            </div>
          </div>

          <div class="form-row-3">
            <div>
              <label for="cost">ä¹°å…¥å‡ä»·ï¼ˆéŸ©å…ƒï¼‰</label>
              <input id="cost" type="number" min="0" step="0.01" placeholder="72000" required />
            </div>
            <div>
              <label for="stopLoss">æ­¢æŸä»·ï¼ˆéŸ©å…ƒï¼Œå¯é€‰ï¼‰</label>
              <input id="stopLoss" type="number" min="0" step="0.01" placeholder="ä¾‹å¦‚ï¼š67000" />
            </div>
            <div>
              <label for="takeProfit">æ­¢ç›ˆä»·ï¼ˆéŸ©å…ƒï¼Œå¯é€‰ï¼‰</label>
              <input id="takeProfit" type="number" min="0" step="0.01" placeholder="ä¾‹å¦‚ï¼š82000" />
            </div>
          </div>

          <div class="help-text">
            åˆå§‹å½“å‰ä»·ä½¿ç”¨æˆæœ¬ä»·ï¼›è¡Œæƒ… key é…å¥½åï¼Œå¯ä»¥ç”¨ã€Œæ‰‹åŠ¨åˆ·æ–°ã€æˆ–ã€Œè‡ªåŠ¨åˆ·æ–°ã€åŒæ­¥éŸ©å›½å®æ—¶ä»·æ ¼ã€‚
          </div>

          <div class="btn-row">
            <button type="submit" class="btn-primary" id="submitBtn">ä¿å­˜æŒä»“</button>
            <button type="button" class="btn-secondary" id="resetFormBtn">æ¸…ç©ºè¡¨å•</button>
            <button type="button" class="btn-ghost" id="clearAllBtn">æ¸…ç©ºå…¨éƒ¨æŒä»“ï¼ˆæœ¬æœºï¼‰</button>
          </div>
        </form>

        <div class="footer-note">
          <span>æ•°æ®åªä¿å­˜åœ¨ä½ è¿™å°ç”µè„‘æµè§ˆå™¨çš„ localStorage ä¸­ï¼Œç¤ºä¾‹ç‰ˆä¸ä¼šä¸Šä¼ æœåŠ¡å™¨ã€‚</span>
          <span>ä»¥åè¦å¤šäººå…±ç”¨ï¼Œå¯ä»¥å†æ¥æ•°æ®åº“ + ç™»å½•ç³»ç»Ÿã€‚</span>
        </div>
      </section>

      <!-- å³ä¾§ï¼šæ±‡æ€» + è¡¨æ ¼ -->
      <section>
        <div class="card">
          <div class="card-title">
            <span>æŒä»“æ¦‚è§ˆ & åˆ·æ–°è®¾ç½®</span>
            <div style="display:flex;gap:6px;align-items:center;">
              <button type="button" class="btn-secondary" id="refreshBtn">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°è¡Œæƒ…</button>
              <button type="button" class="btn-ghost" id="toggleAutoBtn">â± å¼€å¯è‡ªåŠ¨åˆ·æ–°</button>
            </div>
          </div>
          <div class="card-subtitle">
            è‡ªåŠ¨åˆ·æ–°ä¼šå®šæ—¶è°ƒç”¨ Twelve Data éŸ©å›½è¡Œæƒ… APIï¼Œæé†’åªåœ¨é¡µé¢æ‰“å¼€æ—¶æœ‰æ•ˆã€‚
          </div>

          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">æ€»æŠ•å…¥æˆæœ¬</div>
              <div class="summary-value" id="totalCost">â‚© 0</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">å½“å‰æ€»å¸‚å€¼</div>
              <div class="summary-value" id="totalValue">â‚© 0</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">æ€»æµ®åŠ¨ç›ˆäº</div>
              <div class="summary-value" id="totalPnl">â‚© 0</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">æ•´ä½“æ”¶ç›Šç‡</div>
              <div class="summary-value" id="totalReturn">0.00%</div>
            </div>
          </div>

          <div class="summary-footer">
            <span id="positionCount">å½“å‰æŒä»“ï¼š0 æ¡è®°å½•</span>
            <span id="lastUpdate">æœ€è¿‘è¡Œæƒ…æ›´æ–°æ—¶é—´ï¼šâ€”</span>
          </div>
        </div>

        <div class="table-wrapper card" style="padding:0;margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th class="t-left">å®¢æˆ·</th>
                <th class="t-left">è‚¡ç¥¨</th>
                <th>Symbol</th>
                <th>æ•°é‡</th>
                <th>æˆæœ¬</th>
                <th>æ­¢æŸ</th>
                <th>æ­¢ç›ˆ</th>
                <th>å½“å‰ä»·</th>
                <th>å¸‚å€¼</th>
                <th>ç›ˆäº</th>
                <th>æ”¶ç›Šç‡</th>
                <th class="t-left">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
          <div id="emptyTip" class="empty-tip">
            è¿˜æ²¡æœ‰ç™»è®°ä»»ä½•æŒä»“ï¼Œå¯ä»¥å…ˆåœ¨å·¦ä¾§å½•å…¥ä¸€ç¬”å®¢æˆ·æŒä»“è¯•è¯•ã€‚
          </div>
        </div>
      </section>
    </div>

    <div class="powered">
      Data provided by Twelve Data Â· ä¸“ç”¨äºéŸ©å›½ KOSPI / KOSDAQ
    </div>
  </div>

  <!-- æé†’å£°éŸ³ï¼Œå¯è‡ªå·±æ¢ mp3 æ–‡ä»¶æ”¾åœ¨ public ç›®å½• -->
  <audio id="alertSound" src="alert.mp3" preload="auto"></audio>

  <script>
    const STORAGE_KEY = "client_portfolio_with_alerts_korea_v1";
    const API_BASE = ""; // å’Œ server.js åŒåŸŸéƒ¨ç½²ç•™ç©ºï¼›å¦‚æœå‰ç«¯å•ç‹¬æ‰˜ç®¡ï¼Œå°±å†™åç«¯åœ°å€

    const form = document.getElementById("holding-form");
    const editingIdInput = document.getElementById("editingId");
    const clientInput = document.getElementById("client");
    const stockNameInput = document.getElementById("stockName");
    const symbolInput = document.getElementById("symbol");
    const quantityInput = document.getElementById("quantity");
    const costInput = document.getElementById("cost");
    const stopLossInput = document.getElementById("stopLoss");
    const takeProfitInput = document.getElementById("takeProfit");

    const submitBtn = document.getElementById("submitBtn");
    const resetFormBtn = document.getElementById("resetFormBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const toggleAutoBtn = document.getElementById("toggleAutoBtn");

    const tableBody = document.getElementById("tableBody");
    const emptyTip = document.getElementById("emptyTip");

    const totalCostEl = document.getElementById("totalCost");
    const totalValueEl = document.getElementById("totalValue");
    const totalPnlEl = document.getElementById("totalPnl");
    const totalReturnEl = document.getElementById("totalReturn");
    const positionCountEl = document.getElementById("positionCount");
    const lastUpdateEl = document.getElementById("lastUpdate");

    const alertSound = document.getElementById("alertSound");

    let holdings = [];
    let autoTimer = null;
    let autoOn = false;
    const AUTO_INTERVAL_MS = 60 * 1000; // è‡ªåŠ¨åˆ·æ–°é—´éš” 60 ç§’

    function loadHoldingsFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error("è§£ææœ¬åœ°æ•°æ®å¤±è´¥", e);
        return [];
      }
    }

    function saveHoldingsToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(holdings));
    }

    function generateId() {
      return "h_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    }

    function formatCurrencyKRW(v) {
      if (isNaN(v)) return "â‚© 0";
      return "â‚© " + Number(v).toLocaleString("ko-KR", { maximumFractionDigits: 0 });
    }

    function formatPercent(v) {
      if (isNaN(v)) return "0.00%";
      return v.toFixed(2) + "%";
    }

    function formatDateTime(str) {
      if (!str) return "â€”";
      const d = new Date(str);
      if (Number.isNaN(d.getTime())) return "â€”";
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    async function api(url, options = {}) {
      const res = await fetch(API_BASE + url, {
        headers: { "Content-Type": "application/json" },
        ...options
      });
      if (!res.ok) {
        let msg = "è¯·æ±‚å¤±è´¥";
        try {
          const data = await res.json();
          msg = data.error || JSON.stringify(data);
        } catch (e) {}
        throw new Error(msg);
      }
      return res.json();
    }

    function render() {
      renderTable();
      renderSummary();
    }

    function renderTable() {
      tableBody.innerHTML = "";
      if (!holdings.length) {
        emptyTip.style.display = "block";
        return;
      }
      emptyTip.style.display = "none";

      holdings.forEach((h) => {
        const cost = h.quantity * h.cost;
        const value = h.quantity * (h.currentPrice ?? h.cost);
        const pnl = value - cost;
        const rate = cost > 0 ? (pnl / cost) * 100 : 0;

        const tr = document.createElement("tr");

        // é¢„è­¦ç€è‰²
        if (h.currentPrice != null) {
          if (h.stopLoss && h.currentPrice <= h.stopLoss) {
            tr.classList.add("alert-loss");
          } else if (h.takeProfit && h.currentPrice >= h.takeProfit) {
            tr.classList.add("alert-profit");
          }
        }

        const tdClient = document.createElement("td");
        tdClient.className = "t-left";
        tdClient.textContent = h.client;

        const tdStock = document.createElement("td");
        tdStock.className = "t-left";
        tdStock.textContent = h.stockName;

        const tdSymbol = document.createElement("td");
        tdSymbol.textContent = h.symbol;

        const tdQty = document.createElement("td");
        tdQty.textContent = h.quantity.toLocaleString("ko-KR");

        const tdCost = document.createElement("td");
        tdCost.textContent = h.cost.toLocaleString("ko-KR");

        const tdSL = document.createElement("td");
        tdSL.textContent = h.stopLoss ? h.stopLoss.toLocaleString("ko-KR") : "-";

        const tdTP = document.createElement("td");
        tdTP.textContent = h.takeProfit ? h.takeProfit.toLocaleString("ko-KR") : "-";

        const tdCur = document.createElement("td");
        tdCur.textContent = h.currentPrice != null
          ? h.currentPrice.toLocaleString("ko-KR")
          : "-";

        const tdVal = document.createElement("td");
        tdVal.textContent = value.toLocaleString("ko-KR");

        const tdPnl = document.createElement("td");
        tdPnl.textContent = pnl.toLocaleString("ko-KR");
        tdPnl.style.fontWeight = "600";
        tdPnl.style.color = pnl > 0 ? "#16a34a" : pnl < 0 ? "#dc2626" : "#111827";

        const tdRate = document.createElement("td");
        const pill = document.createElement("span");
        pill.className =
          "pill " +
          (rate > 0 ? "pill-gain" : rate < 0 ? "pill-loss" : "pill-neutral");
        pill.textContent = formatPercent(rate);
        tdRate.appendChild(pill);

        const tdActions = document.createElement("td");
        tdActions.className = "t-left";
        const actDiv = document.createElement("div");
        actDiv.className = "actions";

        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "btn-secondary";
        editBtn.textContent = "ç¼–è¾‘";
        editBtn.onclick = () => startEdit(h);

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "btn-danger-outline";
        delBtn.textContent = "åˆ é™¤";
        delBtn.onclick = () => deleteHolding(h.id);

        const oneRefreshBtn = document.createElement("button");
        oneRefreshBtn.type = "button";
        oneRefreshBtn.className = "btn-ghost";
        oneRefreshBtn.textContent = "ğŸ”„";
        oneRefreshBtn.title = "åˆ·æ–°è¯¥è‚¡ç¥¨è¡Œæƒ…";
        oneRefreshBtn.onclick = () => refreshPrices([h.symbol]);

        actDiv.appendChild(oneRefreshBtn);
        actDiv.appendChild(editBtn);
        actDiv.appendChild(delBtn);
        tdActions.appendChild(actDiv);

        tr.appendChild(tdClient);
        tr.appendChild(tdStock);
        tr.appendChild(tdSymbol);
        tr.appendChild(tdQty);
        tr.appendChild(tdCost);
        tr.appendChild(tdSL);
        tr.appendChild(tdTP);
        tr.appendChild(tdCur);
        tr.appendChild(tdVal);
        tr.appendChild(tdPnl);
        tr.appendChild(tdRate);
        tr.appendChild(tdActions);

        tableBody.appendChild(tr);
      });
    }

    function renderSummary() {
      let totalCost = 0;
      let totalValue = 0;
      holdings.forEach((h) => {
        const cost = h.quantity * h.cost;
        const cur = h.currentPrice ?? h.cost;
        const value = h.quantity * cur;
        totalCost += cost;
        totalValue += value;
      });
      const pnl = totalValue - totalCost;
      const rate = totalCost > 0 ? (pnl / totalCost) * 100 : 0;

      totalCostEl.textContent = formatCurrencyKRW(totalCost);
      totalValueEl.textContent = formatCurrencyKRW(totalValue);
      totalPnlEl.textContent = formatCurrencyKRW(pnl);
      totalReturnEl.textContent = formatPercent(rate);

      totalPnlEl.className =
        "summary-value " + (pnl > 0 ? "gain" : pnl < 0 ? "loss" : "");
      totalReturnEl.className =
        "summary-value " + (rate > 0 ? "gain" : rate < 0 ? "loss" : "");

      positionCountEl.textContent = `å½“å‰æŒä»“ï¼š${holdings.length} æ¡è®°å½•`;
    }

    function resetForm() {
      form.reset();
      editingIdInput.value = "";
      submitBtn.textContent = "ä¿å­˜æŒä»“";
      clientInput.focus();
    }

    function startEdit(h) {
      editingIdInput.value = h.id;
      clientInput.value = h.client;
      stockNameInput.value = h.stockName;
      symbolInput.value = h.symbol;
      quantityInput.value = h.quantity;
      costInput.value = h.cost;
      stopLossInput.value = h.stopLoss ?? "";
      takeProfitInput.value = h.takeProfit ?? "";
      submitBtn.textContent = "ä¿å­˜ä¿®æ”¹";
      clientInput.focus();
    }

    function deleteHolding(id) {
      const target = holdings.find((x) => x.id === id);
      if (!target) return;
      if (!confirm(`åˆ é™¤ ${target.client} çš„ ${target.stockName} æŒä»“ï¼Ÿ`)) return;
      holdings = holdings.filter((x) => x.id !== id);
      saveHoldingsToStorage();
      render();
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const client = clientInput.value.trim();
      const stockName = stockNameInput.value.trim();
      const symbol = symbolInput.value.trim();
      const quantity = Number(quantityInput.value);
      const cost = Number(costInput.value);
      const stopLoss = stopLossInput.value ? Number(stopLossInput.value) : null;
      const takeProfit = takeProfitInput.value ? Number(takeProfitInput.value) : null;

      if (!client || !stockName || !symbol || !quantity || !cost) {
        alert("å¿…å¡«é¡¹ä¸èƒ½ä¸ºç©ºï¼ˆå®¢æˆ· / è‚¡ç¥¨ / symbol / æ•°é‡ / æˆæœ¬ï¼‰");
        return;
      }

      const now = new Date().toISOString();
      const id = editingIdInput.value;

      if (id) {
        holdings = holdings.map((h) =>
          h.id === id
            ? {
                ...h,
                client,
                stockName,
                symbol,
                quantity,
                cost,
                stopLoss,
                takeProfit,
                updatedAt: now
              }
            : h
        );
      } else {
        holdings.push({
          id: generateId(),
          client,
          stockName,
          symbol,
          quantity,
          cost,
          stopLoss,
          takeProfit,
          currentPrice: cost,
          createdAt: now,
          updatedAt: now
        });
      }

      saveHoldingsToStorage();
      render();
      resetForm();
    });

    resetFormBtn.addEventListener("click", () => resetForm());

    clearAllBtn.addEventListener("click", () => {
      if (!holdings.length) return;
      if (!confirm("ç¡®å®šæ¸…ç©ºå½“å‰æµè§ˆå™¨é‡Œçš„æ‰€æœ‰æŒä»“è®°å½•ï¼Ÿ")) return;
      holdings = [];
      saveHoldingsToStorage();
      render();
    });

    async function refreshPrices(symbolsOverride) {
      const symbols =
        symbolsOverride ||
        [...new Set(holdings.map((h) => h.symbol).filter(Boolean))];

      if (!symbols.length) return;

      try {
        const result = await api("/api/prices", {
          method: "POST",
          body: JSON.stringify({ symbols })
        });

        const now = new Date().toISOString();
        const triggered = [];

        holdings.forEach((h) => {
          const info = result[h.symbol];
          if (info && info.ok) {
            h.currentPrice = info.price;
            h.updatedAt = now;

            if (h.stopLoss && h.currentPrice <= h.stopLoss) {
              triggered.push({ type: "æ­¢æŸ", h });
            } else if (h.takeProfit && h.currentPrice >= h.takeProfit) {
              triggered.push({ type: "æ­¢ç›ˆ", h });
            }
          }
        });

        saveHoldingsToStorage();
        render();
        lastUpdateEl.textContent = "æœ€è¿‘è¡Œæƒ…æ›´æ–°æ—¶é—´ï¼š" + formatDateTime(now);

        if (triggered.length) {
          try {
            alertSound.currentTime = 0;
            alertSound.play().catch(() => {});
          } catch (e) {}
          const msg = triggered
            .map((t) => `${t.type}è§¦å‘ï¼š${t.h.client} - ${t.h.stockName} (${t.h.symbol})`)
            .join("\n");
          alert(msg);
        }
      } catch (e) {
        alert("åˆ·æ–°è¡Œæƒ…å¤±è´¥ï¼š" + e.message);
      }
    }

    refreshBtn.addEventListener("click", () => refreshPrices());

    function updateAutoBtnText() {
      toggleAutoBtn.textContent = autoOn ? "â± å…³é—­è‡ªåŠ¨åˆ·æ–°" : "â± å¼€å¯è‡ªåŠ¨åˆ·æ–°";
    }

    toggleAutoBtn.addEventListener("click", () => {
      autoOn = !autoOn;
      if (autoOn) {
        refreshPrices();
        autoTimer = setInterval(refreshPrices, AUTO_INTERVAL_MS);
      } else {
        if (autoTimer) clearInterval(autoTimer);
      }
      updateAutoBtnText();
    });

    holdings = loadHoldingsFromStorage();
    render();
    updateAutoBtnText();
  </script>
</body>
</html>
