<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>éŸ©å›½è‚¡ç¥¨å®¢æˆ·æŒä»“è¿½è¸ª</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft YaHei",sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #f3f4f6 40%, #e5e7eb 100%);
      color: #111827;
    }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .layout {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
    }

    .header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title {
      font-size: 22px;
      font-weight: 700;
      color: #0f172a;
    }
    .subtitle {
      font-size: 12px;
      color: #4b5563;
      margin-top: 4px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(37,99,235,0.06);
      border: 1px solid rgba(37,99,235,0.25);
      color: #1d4ed8;
      gap: 4px;
      font-weight: 500;
    }

    .grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 14px 16px;
      box-shadow: 0 12px 25px rgba(15,23,42,0.06);
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #111827;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .card-title span {
      font-size: 11px;
      color: #6b7280;
      font-weight: 400;
    }

    label {
      display: block;
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      border-radius: 9px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #111827;
      font-size: 13px;
      padding: 7px 10px;
      outline: none;
      transition: border-color .15s, box-shadow .15s, background .15s;
    }
    input:focus, select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.25);
      background: #ffffff;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform .05s, box-shadow .1s, filter .1s;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(135deg,#2563eb,#3b82f6);
      color: #f9fafb;
      box-shadow: 0 8px 18px rgba(37,99,235,0.35);
    }
    .btn-primary:hover { filter: brightness(1.03); }
    .btn-secondary {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #cbd5f5;
    }
    .btn-secondary:hover { border-color: #94a3b8; }
    .btn-ghost {
      background: #f9fafb;
      color: #4b5563;
      border: 1px solid #e5e7eb;
    }
    .btn-ghost:hover { border-color: #cbd5f5; }
    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .btn-sm { padding: 4px 10px; font-size: 11px; }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .switch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #6b7280;
    }
    .switch input {
      width: auto;
      height: auto;
      cursor: pointer;
    }

    /* é¡¶éƒ¨æ±‡æ€»åŒºï¼šæ¯ä¸ªå®¢æˆ·ä¸€å¼ å¡ç‰‡ */
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .summary-item {
      padding: 8px 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      gap: 6px;
    }
    .summary-client {
      font-size: 13px;
      font-weight: 600;
      color: #111827;
    }
    .summary-rate {
      font-size: 12px;
      font-weight: 600;
    }
    .summary-rate.positive { color: #16a34a; }
    .summary-rate.negative { color: #dc2626; }
    .summary-line {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #4b5563;
    }
    .summary-line + .summary-line {
      margin-top: 2px;
    }
    .summary-label {
      color: #6b7280;
    }
    .summary-value.positive { color: #16a34a; font-weight: 600; }
    .summary-value.negative { color: #dc2626; font-weight: 600; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    thead {
      background: #f1f5f9;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      white-space: nowrap;
    }
    th {
      font-weight: 500;
      color: #6b7280;
    }
    td.t-left, th.t-left { text-align: left; }

    tbody tr:hover {
      background: #f9fafb;
    }

    .group-row td {
      background: #eef2ff;
      border-bottom-color: #c7d2fe;
      font-weight: 600;
      color: #1e293b;
    }

    .pill {
      padding: 0 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pill-gain { background: #dcfce7; color: #15803d; }
    .pill-loss { background: #fee2e2; color: #b91c1c; }
    .pill-neutral { background: #e5e7eb; color: #4b5563; }

    .tag-alert {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1d4ed8;
    }

    .row-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: nowrap;
    }

    .empty-tip {
      font-size: 12px;
      color: #6b7280;
      padding: 16px 0;
      text-align: center;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #6b7280;
    }

    .footer {
      margin-top: 16px;
      font-size: 10px;
      color: #9ca3af;
      text-align: right;
    }

    /* ==== AI è§£æå¼¹çª— ==== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      z-index: 40;
      display: none;
    }
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      pointer-events: none;
    }
    .modal-inner {
      pointer-events: auto;
      width: 100%;
      max-width: 460px;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.45);
      border: 1px solid #e5e7eb;
      padding: 12px 14px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }
    .modal-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    .modal-body {
      max-height: 260px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.5;
      color: #374151;
      white-space: pre-wrap;
      border-top: 1px solid #e5e7eb;
      padding-top: 6px;
      margin-top: 4px;
    }
    .modal-footer {
      margin-top: 8px;
      text-align: right;
      font-size: 11px;
      color: #9ca3af;
    }
    .btn-ai {
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #eef2ff;
      color: #3730a3;
      padding: 3px 10px;
      font-size: 11px;
      cursor: pointer;
    }
    .btn-ai:hover {
      border-color: #c7d2fe;
      background: #e0e7ff;
    }
  </style>
</head>
<body>
  <div class="layout">
    <header class="header">
      <div>
        <div class="title">éŸ©å›½è‚¡ç¥¨å®¢æˆ·æŒä»“è¿½è¸ª</div>
        <div class="subtitle">
          å®¢æˆ·æŒ‰å§“ååˆ†ç»„ç®¡ç†ï¼Œ<b>æ¯ä½å®¢æˆ·å•ç‹¬ç»Ÿè®¡æ€»æŠ•å…¥æˆæœ¬ / å½“å‰å¸‚å€¼ / æ€»ç›ˆäº / æ”¶ç›Šç‡</b>ï¼Œæ”¯æŒè‡ªåŠ¨åˆ·æ–° Naver è¡Œæƒ…ä¸å¯¼å‡ºæ”¶ç›Šæ—¥æŠ¥ï¼ˆæ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ä¸­ï¼‰ã€‚
        </div>
      </div>
      <div>
        <span class="tag">
          <span>ì‹œì¥</span>
          <strong>KOSPI / KOSDAQ</strong>
        </span>
      </div>
    </header>

    <main class="grid">
      <!-- å·¦ä¾§ï¼šæ–°å¢ / ç¼–è¾‘æŒä»“ -->
      <section class="card">
        <div class="card-title">
          æ–°å¢ / ä¿®æ”¹æŒä»“
          <span>Symbol ç¤ºä¾‹ï¼š005930.KSï¼ˆKOSPIï¼‰ã€353200.KQï¼ˆKOSDAQï¼‰</span>
        </div>

        <form id="holdForm">
          <input type="hidden" id="editId" />

          <label>å®¢æˆ·å§“å / åˆ†ç»„å</label>
          <input id="client" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰ / æ‚Ÿç©ºç»„" required />

          <label style="margin-top:8px;">è‚¡ç¥¨åç§°</label>
          <input id="stockName" placeholder="ä¾‹å¦‚ï¼šì‚¼ì„±ì „ì / ë°•ì…€ë°”ì´ì˜¤" required />

          <label style="margin-top:8px;">è¯åˆ¸ä»£ç ï¼ˆå¯å¸¦ .KS / .KQï¼‰</label>
          <input id="symbol" placeholder="ä¾‹å¦‚ï¼š005930.KS / 323990.KQ" required />

          <div class="row" style="margin-top:8px;">
            <div>
              <label>æŒè‚¡æ•°é‡ï¼ˆè‚¡ï¼‰</label>
              <input id="quantity" type="number" min="1" step="1" required />
            </div>
            <div>
              <label>ä¹°å…¥ä»·æ ¼ï¼ˆâ‚©ï¼‰</label>
              <input id="cost" type="number" min="0" step="1" required />
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <div>
              <label>æ­¢æŸä»·ï¼ˆé€‰å¡«ï¼‰</label>
              <input id="stopLoss" type="number" min="0" step="1" />
            </div>
            <div>
              <label>æ­¢ç›ˆä»·ï¼ˆé€‰å¡«ï¼‰</label>
              <input id="takeProfit" type="number" min="0" step="1" />
            </div>
          </div>

          <div style="margin-top:10px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
            <button type="submit" class="btn btn-primary">
              <span id="submitLabel">ä¿å­˜æŒä»“</span>
            </button>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button type="button" id="resetBtn" class="btn btn-secondary btn-sm">æ¸…ç©ºè¡¨å•</button>
              <button type="button" id="clearAllBtn" class="btn btn-danger btn-sm">æ¸…ç©ºæ‰€æœ‰æŒä»“ï¼ˆæœ¬æœºï¼‰</button>
            </div>
          </div>

          <div style="margin-top:8px; font-size:11px; color:#6b7280;">
            æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ <span class="badge">localStorage</span> ä¸­ï¼Œä»…å¯¹æœ¬æœºå¯è§ã€‚<br/>
            å¦‚éœ€å¤šè®¾å¤‡åŒæ­¥ï¼Œå¯åç»­å‡çº§ä¸ºäº‘ç«¯ç‰ˆã€‚
          </div>
        </form>
      </section>

      <!-- å³ä¾§ï¼šæ±‡æ€» + æ˜ç»† -->
      <section class="card">
        <div class="card-title">
          æŒä»“æ¦‚è§ˆ Â· å®æ—¶æŠ¥ä»·
          <span>
            <span class="tag-alert">æ¯ä½å®¢æˆ·å•ç‹¬æ±‡æ€» Â· è‡ªåŠ¨åˆ·æ–° Naver è¡Œæƒ…</span>
          </span>
        </div>

        <div class="toolbar">
          <div class="toolbar-right">
            <button type="button" id="refreshBtn" class="btn btn-secondary btn-sm">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°è¡Œæƒ…</button>
            <div class="switch">
              <input type="checkbox" id="autoRefreshToggle" />
              <label for="autoRefreshToggle" style="margin:0;">è‡ªåŠ¨åˆ·æ–°</label>
            </div>
            <select id="intervalSelect" style="width:auto;">
              <option value="30" selected>30ç§’</option>
              <option value="60">60ç§’</option>
              <option value="120">120ç§’</option>
            </select>
          </div>
          <div class="toolbar-right">
            <button type="button" id="exportBtn" class="btn btn-ghost btn-sm">ğŸ“¤ å¯¼å‡ºæ”¶ç›Šæ—¥æŠ¥ï¼ˆCSVï¼‰</button>
          </div>
        </div>

        <!-- æ¯ä¸ªå®¢æˆ·ç‹¬ç«‹æ±‡æ€» -->
        <div id="summaryContainer" class="summary"></div>

        <div style="max-height:420px; overflow:auto; border-radius:10px; border:1px solid #e5e7eb; margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th class="t-left">å®¢æˆ·</th>
                <th class="t-left">è‚¡ç¥¨</th>
                <th>ä»£ç </th>
                <th>æ•°é‡</th>
                <th>æˆæœ¬ä»·</th>
                <th>æ­¢æŸ</th>
                <th>æ­¢ç›ˆ</th>
                <th>ç°ä»·</th>
                <th>å¸‚å€¼</th>
                <th>ç›ˆäº</th>
                <th>æ”¶ç›Šç‡</th>
                <th class="t-left">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <div id="emptyTip" class="empty-tip" style="display:none;">
          è¿˜æ²¡æœ‰å½•å…¥ä»»ä½•æŒä»“è®°å½•ï¼Œè¯·åœ¨å·¦ä¾§å¡«å†™å®¢æˆ·ä¸è‚¡ç¥¨ä¿¡æ¯åç‚¹å‡»â€œä¿å­˜æŒä»“â€ã€‚
        </div>

        <div class="footer">
          Data by Naver Finance Â· æ¯ä½ç”¨æˆ·æ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ä¸­ã€‚
        </div>
      </section>
    </main>

    <!-- AI è§£æå¼¹çª— -->
    <div id="aiBackdrop" class="modal-backdrop"></div>
    <div id="aiModal" class="modal" style="display:none;">
      <div class="modal-inner">
        <div class="modal-header">
          <div id="aiModalTitle" class="modal-title">AI è§£æå»ºè®®</div>
          <button type="button" id="aiModalClose" class="btn-ghost btn-sm">å…³é—­</button>
        </div>
        <div id="aiModalContent" class="modal-body"></div>
        <div class="modal-footer">
          ä»¥ä¸Šå†…å®¹ä¸ºç¨‹åºæ ¹æ®å½“å‰æŒä»“è‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "korea_portfolio_tracker_v1";

    const form = document.getElementById("holdForm");
    const editIdInput = document.getElementById("editId");
    const clientInput = document.getElementById("client");
    const stockNameInput = document.getElementById("stockName");
    const symbolInput = document.getElementById("symbol");
    const quantityInput = document.getElementById("quantity");
    const costInput = document.getElementById("cost");
    const stopLossInput = document.getElementById("stopLoss");
    const takeProfitInput = document.getElementById("takeProfit");
    const resetBtn = document.getElementById("resetBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const autoToggle = document.getElementById("autoRefreshToggle");
    const intervalSelect = document.getElementById("intervalSelect");
    const exportBtn = document.getElementById("exportBtn");
    const tableBody = document.getElementById("tableBody");
    const emptyTip = document.getElementById("emptyTip");
    const submitLabel = document.getElementById("submitLabel");
    const summaryContainer = document.getElementById("summaryContainer");

    // AI å¼¹çª—ç›¸å…³ DOM
    const aiBackdrop = document.getElementById("aiBackdrop");
    const aiModal = document.getElementById("aiModal");
    const aiModalTitle = document.getElementById("aiModalTitle");
    const aiModalContent = document.getElementById("aiModalContent");
    const aiModalClose = document.getElementById("aiModalClose");

    let holdings = [];
    let autoTimer = null;

    function loadHoldings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        holdings = raw ? JSON.parse(raw) : [];
      } catch (e) {
        holdings = [];
      }
    }

    function saveHoldings() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(holdings));
      renderAll();
    }

    function formatNumber(n) {
      return n.toLocaleString("ko-KR");
    }

    function formatPercent(v) {
      const n = Number(v);
      if (!isFinite(n)) return "0.00%";
      const s = n.toFixed(2) + "%";
      if (n > 0) return "+" + s;
      return s;
    }

    function groupByClient(list) {
      const map = {};
      list.forEach(h => {
        const key = h.client || "æœªå‘½åå®¢æˆ·";
        if (!map[key]) map[key] = [];
        map[key].push(h);
      });
      return map;
    }

    // === AI å¼¹çª— ===
    function openAiModal(title, content) {
      aiModalTitle.textContent = title;
      aiModalContent.textContent = content;
      aiBackdrop.style.display = "block";
      aiModal.style.display = "flex";
    }

    function closeAiModal() {
      aiBackdrop.style.display = "none";
      aiModal.style.display = "none";
    }

    aiBackdrop.addEventListener("click", closeAiModal);
    aiModalClose.addEventListener("click", closeAiModal);

    // å•åªè‚¡ç¥¨è§£æï¼ˆç²¾ç®€ä¸“ä¸šç‰ˆ + å®¢æˆ·çŸ­å¥ï¼‰
    function generateHoldingAdvice(h) {
      const qty = Number(h.quantity) || 0;
      const cost = Number(h.cost) || 0;
      const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
      const pnl = (cur - cost) * qty;
      const rate = qty * cost > 0 ? ((pnl / (qty * cost)) * 100) : 0;
      const stopLoss = h.stopLoss ? Number(h.stopLoss) : null;
      const takeProfit = h.takeProfit ? Number(h.takeProfit) : null;

      let msg = `ã€${h.stockName}ï½œ${h.symbol}ã€‘\n`;

      // ç›ˆäº & è¶‹åŠ¿ç»“è®º
      if (rate >= 12) msg += `çŸ­çº¿è¶‹åŠ¿åå¼ºï¼Œè·åˆ©åŒºé—´è¾ƒå¥½ã€‚`;
      else if (rate >= 3) msg += `ä»å±å¥åº·éœ‡è¡ï¼Œä¸­æœŸå‘ä¸Šæ¦‚ç‡åå¤§ã€‚`;
      else if (rate > -6) msg += `å›´ç»•æˆæœ¬æ¥å›éœ‡è¡ï¼Œæ–¹å‘æš‚æœªèµ°å‡ºæ¥ã€‚`;
      else if (rate > -15) msg += `å‡ºç°æ˜æ˜¾å›æ’¤ï¼Œè¶‹åŠ¿åå¼±ï¼Œæƒ…ç»ªç•¥è°¨æ…ã€‚`;
      else msg += `å¤„äºæ·±åº¦å›æ’¤åŒºé—´ï¼ŒçŸ­æœŸåå¼¹éš¾åº¦è¾ƒå¤§ï¼Œéœ€æ ¼å¤–è°¨æ…ã€‚`;

      // æ¿å— / æƒ…ç»ª / æˆäº¤é‡ / èµ„é‡‘ç»´åº¦
      msg += ` å½“å‰èµ°åŠ¿çš„å…³é”®åœ¨ï¼šâ‘ æ¿å—æ•´ä½“æƒ…ç»ªæ˜¯å¦é…åˆï¼Œâ‘¡èƒ½å¦æ”¾é‡çªç ´å…³é”®ä»·ä½ï¼Œâ‘¢ä¸»åŠ›/æœºæ„èµ„é‡‘æ˜¯å¦æŒç»­å›æµã€‚`;

      // å®æˆ˜æ“ä½œå»ºè®®ï¼ˆæ­¢ç›ˆ/æ­¢æŸ/ä»“ä½ï¼‰
      if (rate >= 12) {
        msg += ` å»ºè®®ä»¥åˆ†æ‰¹è½è¢‹ä¸ºä¸»ï¼Œé€‚å½“é™ä½ä»“ä½ï¼Œæ—¢ä¿ä½åˆ©æ¶¦åˆä¿ç•™éƒ¨åˆ†ä»“ä½è·Ÿéšè¶‹åŠ¿ã€‚`;
      } else if (rate >= 3) {
        msg += ` å¯ç»§ç»­æŒæœ‰ï¼Œé‡ç‚¹è§‚å¯Ÿæ”¾é‡çªç ´å‰é«˜çš„åŠ›åº¦ï¼Œä¸å®œè¿½é«˜åŠ ä»“ï¼Œå¿…è¦æ—¶é«˜ä½å‡ä¸€éƒ¨åˆ†é”å®šæ”¶ç›Šã€‚`;
      } else if (rate > -6) {
        msg += ` æš‚ä¸å»ºè®®é¢‘ç¹æ“ä½œï¼Œç­‰å‡ºç°æ”¾é‡çªç ´æˆ–è·Œç ´å…³é”®æ”¯æ’‘åå†å†³å®šæ˜¯é¡ºåŠ¿åŠ ä»“è¿˜æ˜¯æœæ–­å‡ä»“ã€‚`;
      } else if (rate > -15) {
        msg += ` å»ºè®®å…ˆé€‚åº¦å‡ä»“ï¼ŒæŠŠæ•´ä½“ä»“ä½å‹ä¸‹æ¥ï¼Œç­‰å¾…æƒ…ç»ªä¿®å¤æˆ–æ”¾é‡ä¼ç¨³åå†è€ƒè™‘é‡æ–°å¸ƒå±€ã€‚`;
      } else {
        msg += ` å»ºè®®ä»¥é£é™©æ§åˆ¶ä¸ºå…ˆï¼Œåˆ©ç”¨åå¼¹åˆ†æ‰¹é€€å‡ºï¼ŒæŠŠèµ„é‡‘è½¬å‘ç¡®å®šæ€§æ›´é«˜ã€æµåŠ¨æ€§æ›´å¥½çš„æ ‡çš„ã€‚`;
      }

      // æ­¢ç›ˆ / æ­¢æŸæé†’
      if (takeProfit && cur >= takeProfit) {
        msg += ` ç›®å‰ä»·æ ¼å·²å¤„åœ¨æˆ–æ¥è¿‘é¢„è®¾æ­¢ç›ˆåŒºé—´ï¼Œå¯æŒ‰åŸè®¡åˆ’åˆ†æ‰¹å…‘ç°åˆ©æ¶¦ã€‚`;
      }
      if (stopLoss && cur <= stopLoss) {
        msg += ` å·²æ¥è¿‘æˆ–è·Œç ´æ­¢æŸçº¿ï¼Œå»ºè®®ä¼˜å…ˆè€ƒè™‘æ‰§è¡Œæ­¢æŸçºªå¾‹ï¼Œé¿å…äºæŸè¿›ä¸€æ­¥æ‰©å¤§ã€‚`;
      }

      // è¡¥ä»“åˆ¤æ–­
      if (rate <= 0) {
        msg += ` åœ¨è¶‹åŠ¿å°šæœªé‡æ–°èµ°å¼ºå‰ï¼Œä¸å»ºè®®è¡¥ä»“ï¼Œé¿å…è¶Šè¡¥è¶Šæ·±ã€‚`;
      } else {
        msg += ` å¦‚åç»­å›è¸©æ”¯æ’‘ä¸”æˆäº¤é‡ç¼©é‡ï¼Œä»·æ ¼ä¼ç¨³åå¯ä»¥å°ä»“ä½ä½å¸è¡¥ä¸€ç‚¹ï¼Œä½†ä¸å®œå¤§å¹…åŠ ç ã€‚`;
      }

      // åå¸‚å…³é”®ç‚¹
      msg += ` åç»­é‡ç‚¹çœ‹æ˜¯å¦â€œæ”¾é‡çªç ´è€Œä¸æ˜¯æ”¾é‡æ»æ¶¨â€ï¼Œçªç ´å¯ä»¥é¡ºåŠ¿å¤šçœ‹ä¸€æ®µï¼Œè‹¥æ”¾é‡ä¸ä¸Šæ¶¨åˆ™åº”ä»¥è½è¢‹å’Œå‡ä»“ä¸ºä¸»ã€‚`;

      // æ¿€åŠ±è¯­æ°”ï¼ˆæŒ‰ç›ˆäºåŒºé—´ï¼‰
      if (rate >= 8) {
        msg += ` å½“å‰æ•´ä½“èŠ‚å¥æŠŠæ¡å¾—ä¸é”™ï¼Œæ¥ä¸‹æ¥ä¸»è¦æ˜¯æ§åˆ¶å›æ’¤ï¼ŒæŠŠè´¦é¢ç›ˆåˆ©å°½é‡è½¬æˆå·²å®ç°æ”¶ç›Šã€‚`;
      } else if (rate >= -5) {
        msg += ` ç›®å‰å±äºæ­£å¸¸æ³¢åŠ¨èŒƒå›´ï¼Œå…³é”®åœ¨äºè€å¿ƒç­‰å¾…æ–¹å‘ï¼Œä¸æ€¥äºåšè¿‡å¤šåŠ¨ä½œã€‚`;
      } else {
        msg += ` ç°åœ¨æœ€é‡è¦çš„æ˜¯ç¨³ä½ä»“ä½å’Œæƒ…ç»ªï¼ŒæŠŠé£é™©æ§åˆ¶åœ¨è‡ªå·±èƒ½æ¥å—çš„èŒƒå›´å†…ï¼Œæ¯”ç›²ç›®â€œè§£å¥—â€æ›´é‡è¦ã€‚`;
      }

      // ç»™å®¢æˆ·çš„çŸ­å¥è¯æœ¯
      let short = "";
      if (rate >= 8) {
        short = `ç°åœ¨è¿™ç¬”ä»“ä½ç›ˆåˆ©ä¸é”™ï¼Œå»ºè®®æ‚¨åˆ†æ‰¹é”å®šä¸€éƒ¨åˆ†æ”¶ç›Šï¼Œå‰©ä½™ä»“ä½æˆ‘ä»¬å†é¡ºåŠ¿çœ‹ä¸€çœ‹å³å¯ã€‚`;
      } else if (rate >= 0) {
        short = `ç›®å‰æ•´ä½“å¤„äºæ­£å¸¸éœ‡è¡ï¼Œå…ˆè§‚å¯Ÿæ˜¯å¦èƒ½æ”¾é‡çªç ´ï¼Œç­‰æ–¹å‘æ›´æ¸…æ™°åå†ä¸€èµ·è°ƒæ•´ã€‚`;
      } else if (rate > -10) {
        short = `è¿™ç¬”ä»“ä½æœ‰ä¸€å®šå›æ’¤ï¼Œå»ºè®®å…ˆæŠŠä»“ä½é€‚å½“é™ä¸€ä¸‹ï¼Œç­‰æƒ…ç»ªå’Œèµ°åŠ¿ç¨³å®šåï¼Œæˆ‘ä»¬å†è€ƒè™‘ä¸‹ä¸€æ­¥ã€‚`;
      } else {
        short = `ç›®å‰è·Œå¹…åå¤§ï¼Œåé¢åå¼¹æˆ‘ä»¬ä¼šåˆ†æ‰¹å¾€å¤–è…¾ä¸€éƒ¨åˆ†ä»“ä½ï¼Œå°½é‡æŠŠæŸå¤±æ§åˆ¶ä½ï¼Œå†æ¢åˆ°æ›´æœ‰æŠŠæ¡çš„æœºä¼šã€‚`;
      }

      msg += `\n\nğŸ“Œ ç»™å®¢æˆ·çš„å‘é€è¯æœ¯ï¼š\n${short}`;

      return msg;
    }

    // å•ä¸ªå®¢æˆ·æ•´ä½“æŒä»“è§£æï¼ˆç²¾ç®€ä¸“ä¸šç‰ˆ + å®¢æˆ·çŸ­å¥ï¼‰
    function generateClientAdvice(clientName, list) {
      let totalCost = 0, totalValue = 0;
      list.forEach(h => {
        const qty = Number(h.quantity) || 0;
        const cost = Number(h.cost) || 0;
        const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
        totalCost += qty * cost;
        totalValue += qty * cur;
      });
      const pnl = totalValue - totalCost;
      const rate = totalCost > 0 ? (pnl / totalCost) * 100 : 0;

      let msg = `ã€${clientName} Â· æŒä»“æ•´ä½“ç‚¹è¯„ã€‘\n`;

      // ç»„åˆæ€»ä½“çŠ¶æ€
      if (rate >= 10) msg += `æ•´ä½“ç›ˆåˆ©è¡¨ç°ä¸é”™ï¼ŒèŠ‚å¥å’Œé€‰è‚¡æ–¹å‘éƒ½åŸºæœ¬ç«™å¾—ä½ã€‚`;
      else if (rate >= 0) msg += `æ•´ä½“å¤„äºå°å¹…ç›ˆäºéœ‡è¡é˜¶æ®µï¼Œä»“ä½é£é™©å¯æ§ï¼Œä½†ç»“æ„è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚`;
      else if (rate > -10) msg += `ç»„åˆå‡ºç°ä¸€å®šå›æ’¤ï¼Œä½†æ•´ä½“ä»åœ¨å¯ç®¡ç†åŒºé—´ï¼Œä¸»è¦é—®é¢˜åœ¨æŒä»“ç»“æ„å’ŒèŠ‚å¥ã€‚`;
      else msg += `ç›®å‰ç»„åˆå›æ’¤åå¤§ï¼Œéœ€è¦å…ˆæŠŠé£é™©é™ä¸‹æ¥ï¼Œå†è€ƒè™‘åç»­æœºä¼šã€‚`;

      // æ‰¾å‡ºæœ€å¤§æƒé‡æ ‡çš„
      const sorted = [...list].map(h => {
        const qty = Number(h.quantity) || 0;
        const cost = Number(h.cost) || 0;
        const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
        return { ...h, value: qty * cur };
      }).sort((a, b) => b.value - a.value);

      if (sorted.length) {
        const top = sorted[0];
        const weight = totalValue > 0 ? (top.value / totalValue) * 100 : 0;
        msg += ` ç›®å‰æƒé‡æœ€é«˜çš„æ˜¯ ${top.stockName}ï¼ˆ${top.symbol}ï¼‰ï¼Œçº¦å ç»„åˆå¸‚å€¼çš„ ${weight.toFixed(1)}%ï¼Œå®ƒçš„èµ°åŠ¿ä¼šå¯¹æ•´ä½“å‡€å€¼å½±å“æ¯”è¾ƒå¤§ï¼Œéœ€è¦é‡ç‚¹ç›¯ä¸€ä¸‹æˆäº¤é‡å’Œæ¿å—æƒ…ç»ªã€‚`;
      }

      // æ“ä½œæ–¹å‘ & é£é™©æ§åˆ¶
      if (rate >= 8) {
        msg += ` åç»­å»ºè®®æŠŠæ¶¨å¹…å¤§ã€æ³¢åŠ¨å¤§çš„æ ‡çš„é€‚å½“å‡ä»“ï¼Œé”å®šä¸€éƒ¨åˆ†ç›ˆåˆ©ï¼ŒåŒæ—¶æŠŠèµ„é‡‘å‘ç¡®å®šæ€§æ›´é«˜ã€åŸºæœ¬é¢æ›´æ¸…æ™°çš„ä¸»çº¿é›†ä¸­ã€‚`;
      } else if (rate >= 0) {
        msg += ` å»ºè®®å‡å°‘è¾¹ç¼˜é¢˜æå’Œæˆäº¤é‡åå¼±çš„ä¸ªè‚¡ä»“ä½ï¼ŒæŠŠä»“ä½æ›´å¤šæ”¾åœ¨æµåŠ¨æ€§å¥½ã€è¶‹åŠ¿æ˜ç¡®çš„æ ¸å¿ƒå“ç§ä¸Šã€‚`;
      } else {
        msg += ` å»ºè®®å…ˆæ¸…ç†äºæŸè¾ƒé‡ã€é€»è¾‘ä¸å†æ¸…æ™°æˆ–æµåŠ¨æ€§è¾ƒå·®çš„æŒä»“ï¼ŒæŠŠæ•´ä½“ä»“ä½é™ä¸‹æ¥ï¼Œè®©ç»„åˆå…ˆå¤„åœ¨ä¸€ä¸ªè‡ªå·±èˆ’æœçš„é£é™©æ°´å¹³ã€‚`;
      }

      msg += ` åå¸‚å…³é”®ä»åœ¨äºï¼šå¤§ç›˜å’Œä¸»æµæ¿å—çš„æƒ…ç»ªèƒ½å¦ä¼ç¨³ã€æˆäº¤é‡èƒ½å¦æ”¾å¤§ï¼Œä»¥åŠèµ„é‡‘æ˜¯å¦ç»§ç»­å‘æ‚¨æŒæœ‰çš„ä¸»çº¿æ–¹å‘é›†ä¸­ã€‚`;

      // æ¿€åŠ±è¯­æ°”
      if (rate >= 6) {
        msg += ` æ•´ä½“æ¥è¯´è¿™æ®µæ—¶é—´çš„èŠ‚å¥æ˜¯ä¸é”™çš„ï¼Œç°åœ¨ä¸»è¦æ˜¯è¾¹èµ°è¾¹è½è¢‹ï¼Œå°½é‡åˆ«æŠŠåˆ°æ‰‹çš„æ”¶ç›Šå†åå›å»ã€‚`;
      } else if (rate >= -5) {
        msg += ` ç›®å‰å±äºæ­£å¸¸æ³¢åŠ¨èŒƒå›´ï¼Œé€šè¿‡ä¸€ç‚¹ç‚¹è°ƒä»“æ¢è‚¡æŠŠç»“æ„è°ƒé¡ºï¼Œåé¢æœºä¼šè¿˜æ˜¯æœ‰çš„ã€‚`;
      } else {
        msg += ` è°ƒæ•´é˜¶æ®µå¾ˆæ­£å¸¸ï¼Œå…³é”®æ˜¯å…ˆç¨³ä½å‡€å€¼å’Œå¿ƒæ€ï¼Œåé¢æœ‰æ›´å¥½çš„æ—¶æœºæˆ‘ä»¬å†æ…¢æ…¢æŠŠæŸå¤±æŠ¢å›æ¥ã€‚`;
      }

      // ç»™å®¢æˆ·çš„çŸ­å¥è¯æœ¯
      let short = "";
      if (rate >= 6) {
        short = `æ•´ä½“ç»„åˆç°åœ¨ç›ˆåˆ©è¿˜ä¸é”™ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šè¾¹èµ°è¾¹é”å®šæ”¶ç›Šï¼Œå°½é‡æŠŠèµšåˆ°çš„å…ˆè£…è¿›å£è¢‹é‡Œã€‚`;
      } else if (rate >= 0) {
        short = `ç›®å‰æ•´ä½“åœ¨æ­£å¸¸éœ‡è¡åŒºé—´ï¼Œæˆ‘ä»¬ä¼šå¸®æ‚¨æŠŠå¼±åŠ¿ä»“ä½æ…¢æ…¢æ¢æ‰ï¼ŒæŠŠèµ„é‡‘é›†ä¸­åˆ°æ›´æœ‰æŠŠæ¡çš„ä¸»çº¿ä¸Šã€‚`;
      } else {
        short = `ç°åœ¨ç»„åˆæœ‰ä¸€å®šå›æ’¤ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä¼˜å…ˆæŠŠé£é™©é«˜ã€æ²¡ä»€ä¹ˆæŠŠæ¡çš„ä»“ä½é™ä¸‹æ¥ï¼Œç­‰èŠ‚å¥ç¨³ä½åå†å»æ‰¾æ›´å¥½çš„æœºä¼šã€‚`;
      }

      msg += `\n\nğŸ“Œ ç»™å®¢æˆ·çš„å‘é€è¯æœ¯ï¼š\n${short}`;

      return msg;
    }

    // é¡¶éƒ¨æ±‡æ€»ï¼šæ¯ä¸ªå®¢æˆ·ä¸€å¼ å¡ç‰‡ + AIæŒ‰é’®
    function renderSummary() {
      summaryContainer.innerHTML = "";
      const groups = groupByClient(holdings);
      const clients = Object.keys(groups).sort();

      if (!clients.length) {
        summaryContainer.innerHTML =
          '<div class="summary-item"><div class="summary-client" style="font-size:12px;color:#6b7280;">æš‚æ— æŒä»“è®°å½•</div></div>';
        return;
      }

      clients.forEach(clientName => {
        const list = groups[clientName];
        let totalCost = 0;
        let totalValue = 0;

        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          totalCost += qty * cost;
          totalValue += qty * cur;
        });

        const pnl = totalValue - totalCost;
        const rate = totalCost > 0 ? (pnl / totalCost) * 100 : 0;

        const card = document.createElement("div");
        card.className = "summary-item";

        const rateClass = pnl > 0 ? "positive" : pnl < 0 ? "negative" : "";
        const pnlClass = pnl > 0 ? "summary-value positive" :
                         pnl < 0 ? "summary-value negative" :
                         "summary-value";

        card.innerHTML = `
          <div class="summary-header">
            <div class="summary-client">${clientName}</div>
            <div class="summary-rate ${rateClass}">${formatPercent(rate)}</div>
          </div>
          <div class="summary-line">
            <span class="summary-label">æ€»æŠ•å…¥æˆæœ¬</span>
            <span>â‚© ${formatNumber(totalCost)}</span>
          </div>
          <div class="summary-line">
            <span class="summary-label">å½“å‰å¸‚å€¼</span>
            <span>â‚© ${formatNumber(totalValue)}</span>
          </div>
          <div class="summary-line">
            <span class="summary-label">æ€»ç›ˆäº</span>
            <span class="${pnlClass}">â‚© ${formatNumber(pnl)}</span>
          </div>
          <div class="summary-line" style="margin-top:4px; justify-content:flex-end;">
            <button type="button" class="btn-ai ai-client-btn">AIè§£æå»ºè®®</button>
          </div>
        `;

        const aiBtn = card.querySelector(".ai-client-btn");
        aiBtn.addEventListener("click", () => {
          const text = generateClientAdvice(clientName, list);
          openAiModal(`${clientName} Â· å®¢æˆ·æ•´ä½“æŒä»“è§£æ`, text);
        });

        summaryContainer.appendChild(card);
      });
    }

    function renderTable() {
      tableBody.innerHTML = "";
      if (!holdings.length) {
        emptyTip.style.display = "block";
        return;
      }
      emptyTip.style.display = "none";

      const groups = groupByClient(holdings);
      const clients = Object.keys(groups).sort();

      clients.forEach(clientName => {
        const list = groups[clientName];

        let clientCost = 0;
        let clientValue = 0;
        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          clientCost += qty * cost;
          clientValue += qty * cur;
        });
        const clientPnl = clientValue - clientCost;
        const clientRate = clientCost > 0 ? (clientPnl / clientCost) * 100 : 0;

        const gtr = document.createElement("tr");
        gtr.className = "group-row";
        const gtd = document.createElement("td");
        gtd.colSpan = 12;
        gtd.className = "t-left";
        gtd.textContent =
          `${clientName}ï½œæŠ•å…¥ â‚© ${formatNumber(clientCost)}ï½œå¸‚å€¼ â‚© ${formatNumber(clientValue)}ï½œç›ˆäº â‚© ${formatNumber(clientPnl)}ï¼ˆ${formatPercent(clientRate)}ï¼‰`;
        gtr.appendChild(gtd);
        tableBody.appendChild(gtr);

        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          const value = qty * cur;
          const pnl = value - qty * cost;
          const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

          const tr = document.createElement("tr");

          if (h.currentPrice != null) {
            const cp = Number(h.currentPrice);
            if (h.stopLoss && cp <= Number(h.stopLoss)) {
              tr.style.background = "#fee2e2";
            } else if (h.takeProfit && cp >= Number(h.takeProfit)) {
              tr.style.background = "#dcfce7";
            }
          }

          const tdClient = document.createElement("td");
          tdClient.className = "t-left";
          tdClient.textContent = h.client;

          const tdStock = document.createElement("td");
          tdStock.className = "t-left";
          tdStock.textContent = h.stockName;

          const tdSymbol = document.createElement("td");
          tdSymbol.textContent = h.symbol;

          const tdQty = document.createElement("td");
          tdQty.textContent = formatNumber(qty);

          const tdCost = document.createElement("td");
          tdCost.textContent = formatNumber(cost);

          const tdSL = document.createElement("td");
          tdSL.textContent = h.stopLoss ? formatNumber(Number(h.stopLoss)) : "-";

          const tdTP = document.createElement("td");
          tdTP.textContent = h.takeProfit ? formatNumber(Number(h.takeProfit)) : "-";

          const tdCur = document.createElement("td");
          tdCur.textContent = h.currentPrice != null ? formatNumber(Number(h.currentPrice)) : "-";

          const tdVal = document.createElement("td");
          tdVal.textContent = formatNumber(value);

          const tdPnl = document.createElement("td");
          tdPnl.textContent = formatNumber(pnl);
          tdPnl.style.color = pnl > 0 ? "#16a34a" : pnl < 0 ? "#dc2626" : "#111827";
          tdPnl.style.fontWeight = "600";

          const tdRate = document.createElement("td");
          const pill = document.createElement("span");
          pill.className =
            "pill " +
            (rate > 0 ? "pill-gain" : rate < 0 ? "pill-loss" : "pill-neutral");
          pill.textContent = formatPercent(rate);
          tdRate.appendChild(pill);

          const tdActions = document.createElement("td");
          tdActions.className = "t-left";
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "row-actions";

          const aiBtn = document.createElement("button");
          aiBtn.type = "button";
          aiBtn.className = "btn-ai";
          aiBtn.textContent = "AIè§£æ";
          aiBtn.onclick = () => {
            const text = generateHoldingAdvice(h);
            openAiModal(`${h.client} Â· ${h.stockName}ï¼ˆ${h.symbol}ï¼‰`, text);
          };

          const oneRefreshBtn = document.createElement("button");
          oneRefreshBtn.type = "button";
          oneRefreshBtn.className = "btn btn-ghost btn-sm";
          oneRefreshBtn.textContent = "ğŸ”„";
          oneRefreshBtn.title = "åˆ·æ–°è¯¥è‚¡ç¥¨è¡Œæƒ…";
          oneRefreshBtn.onclick = () => refreshPrices([h.symbol]);

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-ghost btn-sm";
          editBtn.textContent = "ç¼–è¾‘";
          editBtn.onclick = () => startEdit(h.id);

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-danger btn-sm";
          delBtn.textContent = "åˆ é™¤";
          delBtn.onclick = () => deleteHolding(h.id);

          actionsDiv.appendChild(aiBtn);
          actionsDiv.appendChild(oneRefreshBtn);
          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(delBtn);
          tdActions.appendChild(actionsDiv);

          tr.appendChild(tdClient);
          tr.appendChild(tdStock);
          tr.appendChild(tdSymbol);
          tr.appendChild(tdQty);
          tr.appendChild(tdCost);
          tr.appendChild(tdSL);
          tr.appendChild(tdTP);
          tr.appendChild(tdCur);
          tr.appendChild(tdVal);
          tr.appendChild(tdPnl);
          tr.appendChild(tdRate);
          tr.appendChild(tdActions);

          tableBody.appendChild(tr);
        });
      });
    }

    function renderAll() {
      renderSummary();
      renderTable();
    }

    function resetForm() {
      editIdInput.value = "";
      submitLabel.textContent = "ä¿å­˜æŒä»“";
      form.reset();
    }

    function startEdit(id) {
      const h = holdings.find(x => x.id === id);
      if (!h) return;
      editIdInput.value = h.id;
      clientInput.value = h.client;
      stockNameInput.value = h.stockName;
      symbolInput.value = h.symbol;
      quantityInput.value = h.quantity;
      costInput.value = h.cost;
      stopLossInput.value = h.stopLoss ?? "";
      takeProfitInput.value = h.takeProfit ?? "";
      submitLabel.textContent = "ä¿å­˜ä¿®æ”¹";
    }

    function deleteHolding(id) {
      if (!confirm("ç¡®å®šåˆ é™¤è¯¥æ¡æŒä»“è®°å½•å—ï¼Ÿ")) return;
      holdings = holdings.filter(h => h.id !== id);
      saveHoldings();
      resetForm();
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const client = clientInput.value.trim();
      const stockName = stockNameInput.value.trim();
      const symbol = symbolInput.value.trim();
      const quantity = Number(quantityInput.value);
      const cost = Number(costInput.value);
      const stopLoss = stopLossInput.value ? Number(stopLossInput.value) : null;
      const takeProfit = takeProfitInput.value ? Number(takeProfitInput.value) : null;

      if (!client || !stockName || !symbol || !quantity || !cost) {
        alert("è¯·å®Œæ•´å¡«å†™å¿…å¡«é¡¹ã€‚");
        return;
      }

      const id = editIdInput.value;
      if (id) {
        const idx = holdings.findIndex(h => h.id === id);
        if (idx >= 0) {
          holdings[idx] = {
            ...holdings[idx],
            client, stockName, symbol,
            quantity, cost, stopLoss, takeProfit
          };
        }
      } else {
        holdings.push({
          id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          client,
          stockName,
          symbol,
          quantity,
          cost,
          stopLoss,
          takeProfit,
          currentPrice: null,
          updatedAt: null
        });
      }
      saveHoldings();
      resetForm();
    });

    resetBtn.addEventListener("click", () => {
      resetForm();
    });

    clearAllBtn.addEventListener("click", () => {
      if (!confirm("ç¡®å®šæ¸…ç©ºæœ¬æœºæ‰€æœ‰æŒä»“è®°å½•å—ï¼Ÿ")) return;
      holdings = [];
      saveHoldings();
      resetForm();
    });

    function setAutoRefresh(on) {
      if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
      }
      if (on) {
        const sec = Number(intervalSelect.value) || 60;
        autoTimer = setInterval(() => {
          if (holdings.length) refreshPrices();
        }, sec * 1000);
      }
    }

    autoToggle.addEventListener("change", () => {
      setAutoRefresh(autoToggle.checked);
      if (autoToggle.checked && holdings.length) {
        refreshPrices();
      }
    });

    intervalSelect.addEventListener("change", () => {
      if (autoToggle.checked) setAutoRefresh(true);
    });

    refreshBtn.addEventListener("click", () => {
      refreshPrices();
    });

    // æ‰¹é‡åˆ·æ–°è¡Œæƒ…ï¼ˆåç«¯ /api/prices ä½¿ç”¨ Naverï¼‰
    async function refreshPrices(symbolsOverride) {
      if (!holdings.length && !symbolsOverride) return;

      let symbols;
      if (symbolsOverride && symbolsOverride.length) {
        symbols = Array.from(new Set(symbolsOverride));
      } else {
        symbols = Array.from(new Set(holdings.map(h => h.symbol)));
      }

      try {
        const res = await fetch("/api/prices", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ symbols })
        });
        if (!res.ok) {
          console.error("è¡Œæƒ…åˆ·æ–°å¤±è´¥:", await res.text());
          return;
        }
        const data = await res.json();
        const now = new Date().toISOString();

        holdings.forEach(h => {
          const info = data[h.symbol] || data[h.symbol.toUpperCase()];
          if (info && info.ok) {
            h.currentPrice = Number(info.price);
            h.updatedAt = now;
          }
        });
        saveHoldings();
      } catch (e) {
        console.error("åˆ·æ–°è¡Œæƒ…å¼‚å¸¸:", e);
      }
    }

    exportBtn.addEventListener("click", () => {
      if (!holdings.length) {
        alert("å½“å‰æ²¡æœ‰ä»»ä½•æŒä»“è®°å½•å¯å¯¼å‡ºã€‚");
        return;
      }
      const rows = [];
      rows.push([
        "å®¢æˆ·",
        "è‚¡ç¥¨",
        "ä»£ç ",
        "æ•°é‡",
        "æˆæœ¬ä»·",
        "ç°ä»·",
        "å¸‚å€¼",
        "ç›ˆäº",
        "æ”¶ç›Šç‡(%)",
        "æ­¢æŸ",
        "æ­¢ç›ˆ",
        "æ›´æ–°æ—¶é—´"
      ]);

      holdings.forEach(h => {
        const qty = Number(h.quantity) || 0;
        const cost = Number(h.cost) || 0;
        const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
        const val = qty * cur;
        const pnl = val - qty * cost;
        const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

        rows.push([
          h.client,
          h.stockName,
          h.symbol,
          qty,
          cost,
          cur,
          val,
          pnl,
          rate.toFixed(2),
          h.stopLoss ?? "",
          h.takeProfit ?? "",
          h.updatedAt ? new Date(h.updatedAt).toLocaleString("zh-CN") : ""
        ]);
      });

      rows.push([]);
      rows.push(["=== æŒ‰å®¢æˆ·æ±‡æ€» ==="]);
      const groups = groupByClient(holdings);
      Object.keys(groups).forEach(name => {
        const list = groups[name];
        let costSum = 0, valSum = 0;
        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          costSum += qty * cost;
          valSum += qty * cur;
        });
        const pnl = valSum - costSum;
        const rate = costSum > 0 ? (pnl / costSum) * 100 : 0;
        rows.push([
          name,
          "",
          "",
          "",
          "",
          "",
          valSum,
          pnl,
          rate.toFixed(2)
        ]);
      });

      const csv = rows
        .map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(","))
        .join("\r\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2,"0");
      const d = String(now.getDate()).padStart(2,"0");
      a.href = url;
      a.download = `korea_portfolio_daily_${y}${m}${d}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    loadHoldings();
    renderAll();
  </script>
</body>
</html>
