<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>éŸ©å›½è‚¡ç¥¨å®¢æˆ·æŒä»“è¿½è¸ª</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft YaHei",sans-serif;
      background: radial-gradient(circle at top,#e0f2ff 0,#f9fafb 55%,#e5e7eb 100%);
      color: #111827;
    }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }

    .layout {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .title {
      font-size: 22px;
      font-weight: 700;
      color: #111827;
    }
    .subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1d4ed8;
      gap: 4px;
    }

    .grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 14px 16px;
      box-shadow: 0 14px 30px rgba(15,23,42,0.08);
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #111827;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-title span {
      font-size: 11px;
      color: #9ca3af;
      font-weight: 400;
    }

    label {
      display: block;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      border-radius: 9px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #111827;
      font-size: 13px;
      padding: 7px 10px;
      outline: none;
    }
    input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.35);
      background: #ffffff;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform 0.05s ease, box-shadow 0.08s ease, filter 0.08s ease;
      white-space: nowrap;
    }
    .btn:hover { filter: brightness(1.03); }
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #ecfdf5;
      box-shadow: 0 10px 20px rgba(22,163,74,0.35);
    }
    .btn-secondary {
      background: #eef2ff;
      color: #1e40af;
      border: 1px solid #c7d2fe;
    }
    .btn-ghost {
      background: #f9fafb;
      color: #4b5563;
      border: 1px solid #e5e7eb;
    }
    .btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .btn-sm { padding: 4px 10px; font-size: 11px; }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .switch {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #6b7280;
    }
    .switch input {
      width: auto;
      height: auto;
      cursor: pointer;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(3,minmax(0,1fr));
      gap: 8px;
      margin-bottom: 10px;
    }
    @media (max-width: 900px) {
      .summary { grid-template-columns: repeat(2,minmax(0,1fr)); }
    }
    .summary-item {
      padding: 6px 10px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .summary-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .summary-value {
      font-size: 14px;
      font-weight: 600;
    }
    .summary-value.positive { color: #16a34a; }
    .summary-value.negative { color: #dc2626; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    thead {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
      white-space: nowrap;
    }
    th {
      font-weight: 500;
      color: #6b7280;
    }
    td.t-left, th.t-left { text-align: left; }

    tbody tr:hover {
      background: #f9fafb;
    }

    .group-row td {
      background: #eff6ff;
      border-bottom-color: #dbeafe;
      font-weight: 600;
      color: #1e3a8a;
    }

    .pill {
      padding: 0 8px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pill-gain { background: #dcfce7; color: #16a34a; }
    .pill-loss { background: #fee2e2; color: #b91c1c; }
    .pill-neutral { background: #e5e7eb; color: #4b5563; }

    .row-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: nowrap;
    }

    .empty-tip {
      font-size: 12px;
      color: #9ca3af;
      padding: 16px 0;
      text-align: center;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 0 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #6b7280;
    }

    .footer {
      margin-top: 16px;
      font-size: 10px;
      color: #9ca3af;
      text-align: right;
    }

    /* å¼¹çª—æ ·å¼ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #ffffff;
      border-radius: 14px;
      max-width: 480px;
      width: 100%;
      padding: 16px 18px 14px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.35);
    }
    .modal-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #111827;
    }
    .modal-body {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .modal-footer {
      margin-top: 10px;
      text-align: right;
    }

    /* è‚¡ç¥¨ç­›é€‰è¾“å…¥æ¡† */
    .stock-filter {
      min-width: 220px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      background: #f9fafb;
    }
    .stock-filter:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
      background: #ffffff;
    }
  </style>
</head>
<body>
  <div class="layout">
    <header class="header">
      <div>
        <div class="title">éŸ©å›½è‚¡ç¥¨å®¢æˆ·æŒä»“è¿½è¸ª</div>
        <div class="subtitle">
          å®¢æˆ·æŒ‰å§“ååˆ†ç»„ç®¡ç†ï¼Œæ¯ä½å®¢æˆ·å•ç‹¬ç»Ÿè®¡æŠ•å…¥æˆæœ¬ / å½“å‰å¸‚å€¼ / æ”¶ç›Šç‡ï¼Œæ”¯æŒè‡ªåŠ¨åˆ·æ–° Naver è¡Œæƒ…ä¸å¯¼å‡ºæ”¶ç›Šæ—¥æŠ¥ï¼ˆæ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ä¸­ï¼‰ã€‚
        </div>
      </div>
      <div>
        <span class="tag">
          <span>ì‹œì¥</span>
          <strong>KOSPI Â· KOSDAQ</strong>
        </span>
      </div>
    </header>

    <main class="grid">
      <!-- å·¦ä¾§ï¼šæ–°å¢ / ç¼–è¾‘æŒä»“ -->
      <section class="card">
        <div class="card-title">
          æ–°å¢ / ä¿®æ”¹æŒä»“
          <span>Symbol ç¤ºä¾‹ï¼š005930ï¼ˆKOSPIï¼‰ã€338220ï¼ˆKOSDAQï¼‰</span>
        </div>

        <form id="holdForm">
          <input type="hidden" id="editId" />

          <label>å®¢æˆ·å§“å / åˆ†ç»„å</label>
          <input id="client" placeholder="ä¾‹å¦‚ï¼šæ¨è / é™ˆé›¨VIPç»„" required />

          <label style="margin-top:8px;">è‚¡ç¥¨åç§°</label>
          <input id="stockName" placeholder="ä¾‹å¦‚ï¼šì‚¼ì„±ì „ì / ëŒ€í•œì „ì„ " required />

          <label style="margin-top:8px;">è¯åˆ¸ä»£ç ï¼ˆ6ä½æ•°å­—ï¼‰</label>
          <input id="code" placeholder="ä¾‹å¦‚ï¼š005930 / 338220" required />

          <div class="row" style="margin-top:8px;">
            <div>
              <label>æŒè‚¡æ•°é‡ï¼ˆè‚¡ï¼‰</label>
              <input id="quantity" type="number" min="1" step="1" required />
            </div>
            <div>
              <label>ä¹°å…¥ä»·æ ¼ï¼ˆâ‚©ï¼‰</label>
              <input id="cost" type="number" min="0" step="1" required />
            </div>
          </div>

          <div class="row" style="margin-top:8px;">
            <div>
              <label>æ­¢æŸä»·ï¼ˆé€‰å¡«ï¼‰</label>
              <input id="stopLoss" type="number" min="0" step="1" />
            </div>
            <div>
              <label>æ­¢ç›ˆä»·ï¼ˆé€‰å¡«ï¼‰</label>
              <input id="takeProfit" type="number" min="0" step="1" />
            </div>
          </div>

          <div style="margin-top:10px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
            <button type="submit" class="btn btn-primary">
              <span id="submitLabel">ä¿å­˜æŒä»“</span>
            </button>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button type="button" id="resetBtn" class="btn btn-secondary btn-sm">æ¸…ç©ºè¡¨å•</button>
              <button type="button" id="clearAllBtn" class="btn btn-danger btn-sm">æ¸…ç©ºæ‰€æœ‰æŒä»“ï¼ˆæœ¬æœºï¼‰</button>
            </div>
          </div>

          <div style="margin-top:8px; font-size:11px; color:#6b7280;">
            æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ <span class="badge">localStorage</span> ä¸­ï¼Œåªåœ¨æœ¬æœºå¯è§ã€‚<br/>
            å¦‚éœ€å¤šå°è®¾å¤‡åŒæ­¥ï¼Œå¯ä»¥ä¹‹åå†åšäº‘ç«¯ç‰ˆæœ¬ã€‚
          </div>
        </form>
      </section>

      <!-- å³ä¾§ï¼šæ±‡æ€» + æ˜ç»† -->
      <section class="card">
        <div class="card-title">
          æŒä»“æ¦‚è§ˆ Â· å®æ—¶æŠ¥ä»·
          <span>è‡ªåŠ¨åˆ·æ–° + æ­¢ç›ˆ/æ­¢æŸé¢œè‰²æç¤º</span>
        </div>

        <div class="toolbar">
          <!-- è‚¡ç¥¨ç­›é€‰ -->
          <div class="toolbar-right">
            <input
              id="stockFilter"
              class="stock-filter"
              placeholder="æŒ‰è‚¡ç¥¨åç§° / ä»£ç ç­›é€‰ï¼Œå¦‚ ì‚¼ì„±ì „ì / 005930"
            />
          </div>

          <div class="toolbar-right">
            <button type="button" id="refreshBtn" class="btn btn-secondary btn-sm">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°è¡Œæƒ…</button>
            <div class="switch">
              <input type="checkbox" id="autoRefreshToggle" />
              <label for="autoRefreshToggle" style="margin:0;">è‡ªåŠ¨åˆ·æ–°</label>
            </div>
            <select id="intervalSelect" style="width:auto; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #d1d5db;">
              <option value="30">30ç§’</option>
              <option value="60" selected>60ç§’</option>
              <option value="120">120ç§’</option>
            </select>
          </div>

          <div class="toolbar-right">
            <button type="button" id="exportBtn" class="btn btn-ghost btn-sm">ğŸ“¤ å¯¼å‡ºæ”¶ç›Šæ—¥æŠ¥ï¼ˆCSVï¼‰</button>
          </div>
        </div>

        <div class="summary">
          <div class="summary-item">
            <div class="summary-label">æ€»æŠ•å…¥æˆæœ¬</div>
            <div class="summary-value" id="sumCost">â‚© 0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">å½“å‰å¸‚å€¼</div>
            <div class="summary-value" id="sumValue">â‚© 0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">æ€»ç›ˆäº / æ”¶ç›Šç‡</div>
            <div class="summary-value" id="sumPnl">â‚© 0ï¼ˆ0.00%ï¼‰</div>
          </div>
        </div>

        <div style="max-height:420px; overflow:auto; border-radius:10px; border:1px solid #e5e7eb;">
          <table>
            <thead>
              <tr>
                <th class="t-left">å®¢æˆ·</th>
                <th class="t-left">è‚¡ç¥¨</th>
                <th>ä»£ç </th>
                <th>æ•°é‡</th>
                <th>æˆæœ¬ä»·</th>
                <th>æ­¢æŸ</th>
                <th>æ­¢ç›ˆ</th>
                <th>ç°ä»·</th>
                <th>å¸‚å€¼</th>
                <th>ç›ˆäº</th>
                <th>æ”¶ç›Šç‡</th>
                <th class="t-left">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <div id="emptyTip" class="empty-tip" style="display:none;">
          è¿˜æ²¡æœ‰å½•å…¥ä»»ä½•æŒä»“è®°å½•ï¼Œè¯·åœ¨å·¦ä¾§å¡«å†™å®¢æˆ·ä¸è‚¡ç¥¨ä¿¡æ¯åç‚¹å‡»â€œä¿å­˜æŒä»“â€ã€‚
        </div>

        <div class="footer">
          Data by Naver Finance Â· æ¯ä½ç”¨æˆ·æ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ä¸­ã€‚
        </div>
      </section>
    </main>
  </div>

  <!-- AI è§£æå¼¹çª— -->
  <div id="aiModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-title">AI è§£æå»ºè®®ï¼ˆç¤ºæ„é€»è¾‘ï¼Œæœ¬åœ°ç”Ÿæˆï¼‰</div>
      <div id="aiModalBody" class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" onclick="closeAiModal()">å¥½çš„ï¼ŒçŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <!-- å–å‡ºå¼¹çª— -->
  <div id="sellModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-title">å–å‡ºæ€»ç»“ï¼ˆä»…æœ¬åœ°æ¨¡æ‹Ÿï¼‰</div>
      <div id="sellModalBody" class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" onclick="closeSellModal()">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    // ==== æœ¬åœ°å­˜å‚¨é”® ====
    const STORAGE_KEY = "korea_portfolio_holdings_v2";

    // ==== DOM ====
    const form = document.getElementById("holdForm");
    const editIdInput = document.getElementById("editId");
    const clientInput = document.getElementById("client");
    const stockNameInput = document.getElementById("stockName");
    const codeInput = document.getElementById("code");
    const quantityInput = document.getElementById("quantity");
    const costInput = document.getElementById("cost");
    const stopLossInput = document.getElementById("stopLoss");
    const takeProfitInput = document.getElementById("takeProfit");
    const resetBtn = document.getElementById("resetBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const autoToggle = document.getElementById("autoRefreshToggle");
    const intervalSelect = document.getElementById("intervalSelect");
    const exportBtn = document.getElementById("exportBtn");
    const tableBody = document.getElementById("tableBody");
    const emptyTip = document.getElementById("emptyTip");
    const sumCostEl = document.getElementById("sumCost");
    const sumValueEl = document.getElementById("sumValue");
    const sumPnlEl = document.getElementById("sumPnl");
    const submitLabel = document.getElementById("submitLabel");

    const aiModalBackdrop = document.getElementById("aiModalBackdrop");
    const aiModalBody = document.getElementById("aiModalBody");
    const sellModalBackdrop = document.getElementById("sellModalBackdrop");
    const sellModalBody = document.getElementById("sellModalBody");
    const stockFilterInput = document.getElementById("stockFilter");

    let holdings = [];
    let autoTimer = null;
    let stockFilterKeyword = ""; // å½“å‰è‚¡ç¥¨ç­›é€‰å…³é”®å­—

    function loadHoldings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        holdings = raw ? JSON.parse(raw) : [];
      } catch (e) {
        holdings = [];
      }
    }

    function saveHoldings() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(holdings));
      renderAll();
    }

    function formatNumber(n) {
      return Number(n || 0).toLocaleString("ko-KR");
    }

    function formatPercent(v) {
      const n = Number(v);
      if (!isFinite(n)) return "0.00%";
      const s = n.toFixed(2) + "%";
      return n > 0 ? "+" + s : s;
    }

    function groupByClient(list) {
      const map = {};
      list.forEach(h => {
        const key = h.client || "æœªå‘½åå®¢æˆ·";
        if (!map[key]) map[key] = [];
        map[key].push(h);
      });
      return map;
    }

    function renderSummary() {
      let totalCost = 0;
      let totalValue = 0;

      holdings.forEach(h => {
        const qty = Number(h.quantity) || 0;
        const cost = Number(h.cost) || 0;
        const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
        totalCost += qty * cost;
        totalValue += qty * cur;
      });

      const pnl = totalValue - totalCost;
      const rate = totalCost > 0 ? (pnl / totalCost) * 100 : 0;

      sumCostEl.textContent = "â‚© " + formatNumber(totalCost);
      sumValueEl.textContent = "â‚© " + formatNumber(totalValue);

      sumPnlEl.textContent = `â‚© ${formatNumber(pnl)}ï¼ˆ${formatPercent(rate)}ï¼‰`;
      sumPnlEl.classList.remove("positive","negative");
      if (pnl > 0) sumPnlEl.classList.add("positive");
      else if (pnl < 0) sumPnlEl.classList.add("negative");
    }

    function renderTable() {
      tableBody.innerHTML = "";

      // æ ¹æ®ç­›é€‰å…³é”®å­—è¿‡æ»¤ï¼šæŒ‰è‚¡ç¥¨åç§° or ä»£ç 
      let filtered = holdings;
      if (stockFilterKeyword) {
        filtered = holdings.filter(h => {
          const name = (h.stockName || "").toLowerCase();
          const code = (h.code || "").toLowerCase();
          return (
            name.includes(stockFilterKeyword) ||
            code.includes(stockFilterKeyword)
          );
        });
      }

      if (!filtered.length) {
        emptyTip.style.display = "block";
        emptyTip.textContent = stockFilterKeyword
          ? `æœªæ‰¾åˆ°åŒ…å«ã€Œ${stockFilterKeyword}ã€çš„æŒä»“è®°å½•ã€‚`
          : "è¿˜æ²¡æœ‰å½•å…¥ä»»ä½•æŒä»“è®°å½•ï¼Œè¯·åœ¨å·¦ä¾§å¡«å†™å®¢æˆ·ä¸è‚¡ç¥¨ä¿¡æ¯åç‚¹å‡»â€œä¿å­˜æŒä»“â€ã€‚";
        return;
      }
      emptyTip.style.display = "none";

      const groups = groupByClient(filtered);
      const clients = Object.keys(groups).sort();

      clients.forEach(clientName => {
        const list = groups[clientName];

        let clientCost = 0;
        let clientValue = 0;
        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          clientCost += qty * cost;
          clientValue += qty * cur;
        });
        const clientPnl = clientValue - clientCost;
        const clientRate = clientCost > 0 ? (clientPnl / clientCost) * 100 : 0;

        const gtr = document.createElement("tr");
        gtr.className = "group-row";
        const gtd = document.createElement("td");
        gtd.colSpan = 12;
        gtd.className = "t-left";
        gtd.textContent =
          `${clientName}ï½œæŠ•å…¥ â‚© ${formatNumber(clientCost)}ï½œå¸‚å€¼ â‚© ${formatNumber(clientValue)}ï½œç›ˆäº â‚© ${formatNumber(clientPnl)}ï¼ˆ${formatPercent(clientRate)}ï¼‰`;
        gtr.appendChild(gtd);
        tableBody.appendChild(gtr);

        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          const value = qty * cur;
          const pnl = value - qty * cost;
          const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

          const tr = document.createElement("tr");

          if (h.currentPrice != null) {
            const cp = Number(h.currentPrice);
            if (h.stopLoss && cp <= Number(h.stopLoss)) {
              tr.style.background = "#fee2e2";
            } else if (h.takeProfit && cp >= Number(h.takeProfit)) {
              tr.style.background = "#dcfce7";
            }
          }

          const tdClient = document.createElement("td");
          tdClient.className = "t-left";
          tdClient.textContent = h.client;

          const tdStock = document.createElement("td");
          tdStock.className = "t-left";
          if (h.code) {
            const link = document.createElement("a");
            link.href = `https://finance.naver.com/item/sise.nhn?code=${h.code}`;
            link.target = "_blank";
            link.rel = "noopener noreferrer";
            link.textContent = h.stockName || "-";
            tdStock.appendChild(link);
          } else {
            tdStock.textContent = h.stockName;
          }

          const tdCode = document.createElement("td");
          tdCode.textContent = h.code || "-";

          const tdQty = document.createElement("td");
          tdQty.textContent = formatNumber(qty);

          const tdCost = document.createElement("td");
          tdCost.textContent = formatNumber(cost);

          const tdSL = document.createElement("td");
          tdSL.textContent = h.stopLoss ? formatNumber(Number(h.stopLoss)) : "-";

          const tdTP = document.createElement("td");
          tdTP.textContent = h.takeProfit ? formatNumber(Number(h.takeProfit)) : "-";

          const tdCur = document.createElement("td");
          tdCur.textContent = h.currentPrice != null ? formatNumber(Number(h.currentPrice)) : "-";

          const tdVal = document.createElement("td");
          tdVal.textContent = formatNumber(value);

          const tdPnl = document.createElement("td");
          tdPnl.textContent = formatNumber(pnl);
          tdPnl.style.color = pnl > 0 ? "#16a34a" : pnl < 0 ? "#b91c1c" : "#111827";
          tdPnl.style.fontWeight = "600";

          const tdRate = document.createElement("td");
          const pill = document.createElement("span");
          pill.className =
            "pill " +
            (rate > 0 ? "pill-gain" : rate < 0 ? "pill-loss" : "pill-neutral");
          pill.textContent = formatPercent(rate);
          tdRate.appendChild(pill);

          const tdActions = document.createElement("td");
          tdActions.className = "t-left";
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "row-actions";

          const oneRefreshBtn = document.createElement("button");
          oneRefreshBtn.type = "button";
          oneRefreshBtn.className = "btn btn-ghost btn-sm";
          oneRefreshBtn.textContent = "ğŸ”„";
          oneRefreshBtn.title = "åˆ·æ–°è¯¥è‚¡ç¥¨è¡Œæƒ…";
          oneRefreshBtn.onclick = () => refreshPrices([h.code]);

          const aiBtn = document.createElement("button");
          aiBtn.type = "button";
          aiBtn.className = "btn btn-secondary btn-sm";
          aiBtn.textContent = "AIè§£æ";
          aiBtn.onclick = () => openAiModal(h);

          const sellBtn = document.createElement("button");
          sellBtn.type = "button";
          sellBtn.className = "btn btn-ghost btn-sm";
          sellBtn.textContent = "å–å‡º";
          sellBtn.onclick = () => openSellModal(h);

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-ghost btn-sm";
          editBtn.textContent = "ç¼–è¾‘";
          editBtn.onclick = () => startEdit(h.id);

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-danger btn-sm";
          delBtn.textContent = "åˆ é™¤";
          delBtn.onclick = () => deleteHolding(h.id);

          actionsDiv.appendChild(oneRefreshBtn);
          actionsDiv.appendChild(aiBtn);
          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(sellBtn);
          actionsDiv.appendChild(delBtn);
          tdActions.appendChild(actionsDiv);

          tr.appendChild(tdClient);
          tr.appendChild(tdStock);
          tr.appendChild(tdCode);
          tr.appendChild(tdQty);
          tr.appendChild(tdCost);
          tr.appendChild(tdSL);
          tr.appendChild(tdTP);
          tr.appendChild(tdCur);
          tr.appendChild(tdVal);
          tr.appendChild(tdPnl);
          tr.appendChild(tdRate);
          tr.appendChild(tdActions);

          tableBody.appendChild(tr);
        });
      });
    }

    function renderAll() {
      renderSummary();
      renderTable();
    }

    function resetForm() {
      editIdInput.value = "";
      submitLabel.textContent = "ä¿å­˜æŒä»“";
      form.reset();
    }

    function startEdit(id) {
      const h = holdings.find(x => x.id === id);
      if (!h) return;
      editIdInput.value = h.id;
      clientInput.value = h.client;
      stockNameInput.value = h.stockName;
      codeInput.value = h.code;
      quantityInput.value = h.quantity;
      costInput.value = h.cost;
      stopLossInput.value = h.stopLoss ?? "";
      takeProfitInput.value = h.takeProfit ?? "";
      submitLabel.textContent = "ä¿å­˜ä¿®æ”¹";
    }

    function deleteHolding(id) {
      if (!confirm("ç¡®å®šåˆ é™¤è¯¥æ¡æŒä»“è®°å½•å—ï¼Ÿ")) return;
      holdings = holdings.filter(h => h.id !== id);
      saveHoldings();
      resetForm();
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const client = clientInput.value.trim();
      const stockName = stockNameInput.value.trim();
      const code = codeInput.value.trim();
      const quantity = Number(quantityInput.value);
      const cost = Number(costInput.value);
      const stopLoss = stopLossInput.value ? Number(stopLossInput.value) : null;
      const takeProfit = takeProfitInput.value ? Number(takeProfitInput.value) : null;

      if (!client || !stockName || !code || !quantity || !cost) {
        alert("è¯·å®Œæ•´å¡«å†™å¿…å¡«é¡¹ã€‚");
        return;
      }

      const id = editIdInput.value;
      if (id) {
        const idx = holdings.findIndex(h => h.id === id);
        if (idx >= 0) {
          holdings[idx] = {
            ...holdings[idx],
            client, stockName, code,
            quantity, cost, stopLoss, takeProfit
          };
        }
      } else {
        holdings.push({
          id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          client,
          stockName,
          code,
          quantity,
          cost,
          stopLoss,
          takeProfit,
          currentPrice: null,
          updatedAt: null
        });
      }
      saveHoldings();
      resetForm();
    });

    resetBtn.addEventListener("click", () => {
      resetForm();
    });

    clearAllBtn.addEventListener("click", () => {
      if (!confirm("ç¡®å®šæ¸…ç©ºæœ¬æœºæ‰€æœ‰æŒä»“è®°å½•å—ï¼Ÿ")) return;
      holdings = [];
      saveHoldings();
      resetForm();
    });

    // === è‡ªåŠ¨åˆ·æ–°ç›¸å…³ ===
    function setAutoRefresh(on) {
      if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
      }
      if (on) {
        const sec = Number(intervalSelect.value) || 60;
        autoTimer = setInterval(() => {
          if (holdings.length) refreshPrices();
        }, sec * 1000);
      }
    }

    autoToggle.addEventListener("change", () => {
      setAutoRefresh(autoToggle.checked);
      if (autoToggle.checked && holdings.length) {
        refreshPrices();
      }
    });

    intervalSelect.addEventListener("change", () => {
      if (autoToggle.checked) setAutoRefresh(true);
    });

    refreshBtn.addEventListener("click", () => {
      refreshPrices();
    });

    // è‚¡ç¥¨ç­›é€‰è¾“å…¥
    stockFilterInput.addEventListener("input", () => {
      stockFilterKeyword = stockFilterInput.value.trim().toLowerCase();
      renderTable();
    });

    // === æ ¸å¿ƒï¼šåˆ·æ–°è¡Œæƒ… ===
    async function refreshPrices(symbolsOverride) {
      try {
        if (!holdings.length && !symbolsOverride) return;

        let symbols;
        if (symbolsOverride && symbolsOverride.length) {
          symbols = Array.from(new Set(symbolsOverride.filter(Boolean)));
        } else {
          symbols = Array.from(
            new Set(holdings.map(h => h.code).filter(Boolean))
          );
        }
        if (!symbols.length) return;

        const res = await fetch("/api/prices", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ symbols })
        });

        if (!res.ok) {
          console.error("è¡Œæƒ…æ¥å£é”™è¯¯:", await res.text());
          return;
        }

        const data = await res.json(); // { "005930":{ok:true,price:xxx}, ... }
        const now = new Date().toISOString();

        holdings.forEach(h => {
          const info = data[h.code];
          if (info && info.ok) {
            h.currentPrice = Number(info.price);
            h.updatedAt = now;
          }
        });

        saveHoldings();
        console.log("ğŸ“Œ è¡Œæƒ…åˆ·æ–°å®Œæˆ");
      } catch (e) {
        console.error("åˆ·æ–°è¡Œæƒ…å¼‚å¸¸:", e);
      }
    }

    // === å¯¼å‡ºæ”¶ç›Šæ—¥æŠ¥ï¼ˆCSVï¼‰ ===
    exportBtn.addEventListener("click", () => {
      if (!holdings.length) {
        alert("å½“å‰æ²¡æœ‰ä»»ä½•æŒä»“è®°å½•å¯å¯¼å‡ºã€‚");
        return;
      }
      const rows = [];
      rows.push([
        "å®¢æˆ·",
        "è‚¡ç¥¨",
        "ä»£ç ",
        "æ•°é‡",
        "æˆæœ¬ä»·",
        "ç°ä»·",
        "å¸‚å€¼",
        "ç›ˆäº",
        "æ”¶ç›Šç‡(%)",
        "æ­¢æŸ",
        "æ­¢ç›ˆ",
        "æ›´æ–°æ—¶é—´"
      ]);

      holdings.forEach(h => {
        const qty = Number(h.quantity) || 0;
        const cost = Number(h.cost) || 0;
        const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
        const val = qty * cur;
        const pnl = val - qty * cost;
        const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

        rows.push([
          h.client,
          h.stockName,
          h.code,
          qty,
          cost,
          cur,
          val,
          pnl,
          rate.toFixed(2),
          h.stopLoss ?? "",
          h.takeProfit ?? "",
          h.updatedAt ? new Date(h.updatedAt).toLocaleString("zh-CN") : ""
        ]);
      });

      rows.push([]);
      rows.push(["=== æŒ‰å®¢æˆ·æ±‡æ€» ==="]);
      const groups = groupByClient(holdings);
      Object.keys(groups).forEach(name => {
        const list = groups[name];
        let costSum = 0, valSum = 0;
        list.forEach(h => {
          const qty = Number(h.quantity) || 0;
          const cost = Number(h.cost) || 0;
          const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
          costSum += qty * cost;
          valSum += qty * cur;
        });
        const pnl = valSum - costSum;
        const rate = costSum > 0 ? (pnl / costSum) * 100 : 0;
        rows.push([
          name,
          "",
          "",
          "",
          "",
          "",
          valSum,
          pnl,
          rate.toFixed(2)
        ]);
      });

      const csv = rows
        .map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(","))
        .join("\r\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2,"0");
      const d = String(now.getDate()).padStart(2,"0");
      a.href = url;
      a.download = `korea_portfolio_daily_${y}${m}${d}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // === AI è§£æå¼¹çª—ï¼ˆæœ¬åœ°è§„åˆ™ç”Ÿæˆä¸€æ®µè¯ï¼‰ ===
    function openAiModal(h) {
      const qty = Number(h.quantity) || 0;
      const cost = Number(h.cost) || 0;
      const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
      const value = qty * cur;
      const pnl = value - qty * cost;
      const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

      let tone = "";
      if (rate > 20) tone = "æ”¶ç›ŠåŒºé—´å·²ç»æ¯”è¾ƒå¯è§‚ï¼Œå¯ä»¥è€ƒè™‘åˆ†æ‰¹é”å®šåˆ©æ¶¦ï¼Œé¿å…æƒ…ç»ªåŒ–è¿½é«˜ã€‚";
      else if (rate > 5) tone = "æ•´ä½“èŠ‚å¥è¿˜å¯ä»¥ï¼ŒçŸ­æœŸæ³¨æ„é‡èƒ½å˜åŒ–ï¼Œçªç ´æ— é‡è¦é€‚å½“æ”¶ç¼©ä»“ä½ã€‚";
      else if (rate > -5) tone = "ç›®å‰ç›ˆäºéƒ½ä¸å¤§ï¼Œå…ˆæŠŠä»“ä½å½“æˆâ€œè§‚å¯Ÿç¥¨â€ï¼Œé‡ç‚¹ç›¯ä½æ”¯æ’‘ä½å’Œæˆäº¤é‡ã€‚";
      else if (rate > -15) tone = "å›æ’¤å¹…åº¦ä¸ç®—å°äº†ï¼Œä¸‹æ–¹æ”¯æ’‘ä¸€æ—¦è·Œç ´è¦æœæ–­æ‰§è¡Œæ­¢æŸï¼Œä¸è¦å†æ‹–å»¶ã€‚";
      else tone = "äºæŸåŒºé—´å·²ç»åå¤§äº†ï¼Œå»ºè®®å…ˆæŠŠä»“ä½æ‹†æˆå‡ ä»½ï¼ŒæŒ‰åå¼¹èŠ‚å¥åˆ†æ‰¹å‡æ‰ï¼Œæ§åˆ¶æ•´ä½“é£é™©ã€‚";

      const text =
        `ã€${h.client || "å®¢æˆ·"} Â· ${h.stockName || ""}ã€‘\n` +
        `å½“å‰ä»“ä½çº¦ ${qty.toLocaleString("ko-KR")} è‚¡ï¼Œæˆæœ¬ä»· â‚©${formatNumber(cost)}ï¼Œ` +
        `æœ€æ–°ä»·çº¦ â‚©${formatNumber(cur)}ï¼Œæµ®åŠ¨ç›ˆäºçº¦ â‚©${formatNumber(pnl)}ï¼ˆ${formatPercent(rate)}ï¼‰ã€‚\n\n` +
        `èµ°åŠ¿ä¸Šä¼˜å…ˆå…³æ³¨ï¼šå‰æœŸå¹³å°æ”¯æ’‘ã€5æ—¥/20æ—¥å‡çº¿ä»¥åŠæœ€è¿‘æ”¾é‡ä½ç½®ï¼Œå¦‚æœåç»­æ”¾é‡ä¸Šå†²ä½†å®ä½“æ”¶å¾—å¾ˆçŸ­ï¼Œè¦é˜²èŒƒä¸»åŠ›é«˜ä½å‡ä»“ã€‚\n` +
        `æ­¢ç›ˆæ­¢æŸä¸Šå»ºè®®ï¼šæ­¢æŸä»·å¯ä»¥å‚è€ƒä½ åœ¨ç³»ç»Ÿé‡Œå¡«å†™çš„ä»·ä½ï¼Œè‹¥æœªå¡«å†™ï¼Œå¯å…ˆæŠŠâ€œæœ€è¿‘æ˜æ˜¾æ”¯æ’‘ä½ä¸‹æ–¹ 2~3%â€å½“ä½œç¡¬æ­¢æŸçº¿ï¼›æ­¢ç›ˆåˆ™åˆ†ä¸¤æ­¥æ‰§è¡Œï¼Œ` +
        `ç¬¬ä¸€ç›®æ ‡ä½åœ¨å‰é«˜é™„è¿‘ï¼Œç¬¬äºŒç›®æ ‡ä½çœ‹æ”¾é‡çªç ´åçš„è·Ÿè¸ªç©ºé—´ã€‚\n\n` +
        tone + ` æ•´ä½“ä¸ŠèŠ‚å¥å®å¯æ…¢ä¸€ç‚¹ï¼Œä¹Ÿå°½é‡åšåˆ°â€œå…ˆè°ˆå¥½æ­¢ç›ˆæ­¢æŸï¼Œå†å†³å®šæ˜¯å¦åŠ ä»“æˆ–ç»§ç»­æŒæœ‰â€ã€‚`;

      aiModalBody.textContent = text;
      aiModalBackdrop.style.display = "flex";
    }

    function closeAiModal() {
      aiModalBackdrop.style.display = "none";
    }

    // === å–å‡ºå¼¹çª—ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼Œä¸çœŸæ­£åˆ é™¤æŒä»“ï¼‰ ===
    function openSellModal(h) {
      const qty = Number(h.quantity) || 0;
      const cost = Number(h.cost) || 0;
      const cur = h.currentPrice != null ? Number(h.currentPrice) : cost;
      const value = qty * cur;
      const pnl = value - qty * cost;
      const rate = qty * cost > 0 ? (pnl / (qty * cost)) * 100 : 0;

      const text =
        `ã€æ¨¡æ‹Ÿå–å‡ºæ€»ç»“ã€‘\n` +
        `å®¢æˆ·ï¼š${h.client || "-"}\n` +
        `æ ‡çš„ï¼š${h.stockName || ""}ï¼ˆ${h.code || ""}ï¼‰\n` +
        `æ•°é‡ï¼š${qty.toLocaleString("ko-KR")} è‚¡\n` +
        `ä¹°å…¥æˆæœ¬ï¼šâ‚©${formatNumber(cost)}\n` +
        `å‡è®¾å–å‡ºä»·ï¼šâ‚©${formatNumber(cur)}ï¼ˆå½“å‰ä»·ï¼‰\n\n` +
        `æŠ•å…¥æˆæœ¬åˆè®¡ï¼šâ‚©${formatNumber(qty * cost)}\n` +
        `å–å‡ºé‡‘é¢åˆè®¡ï¼šâ‚©${formatNumber(value)}\n` +
        `æœ¬æ¬¡ç›ˆäºï¼šâ‚©${formatNumber(pnl)}ï¼ˆ${formatPercent(rate)}ï¼‰\n\n` +
        `æç¤ºï¼šè¿™é‡Œåªæ˜¯å¸®åŠ©ä½ å¿«é€Ÿç»™å®¢æˆ·æ±‡æ€»ç»“æœï¼Œå¹¶æ²¡æœ‰çœŸæ­£ä»ç³»ç»Ÿé‡Œåˆ é™¤æŒä»“è®°å½•ï¼Œå¦‚éœ€æ¸…ä»“ï¼Œè¯·åœ¨ç¡®è®¤åæ‰‹åŠ¨è°ƒæ•´ã€‚`;

      sellModalBody.textContent = text;
      sellModalBackdrop.style.display = "flex";
    }

    function closeSellModal() {
      sellModalBackdrop.style.display = "none";
    }

    // === åˆå§‹åŒ– ===
    loadHoldings();
    renderAll();
  </script>
</body>
</html>
